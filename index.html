<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-应用程序进程启动流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.578Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="应用程序进程启动流程"><a href="#应用程序进程启动流程" class="headerlink" title="应用程序进程启动流程"></a><center>应用程序进程启动流程</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<h4 id="ATMS发送启动应用程序进程请求"><a href="#ATMS发送启动应用程序进程请求" class="headerlink" title="ATMS发送启动应用程序进程请求"></a>ATMS发送启动应用程序进程请求</h4><h5 id="1-ATMS处理启动应用程序基本数据"><a href="#1-ATMS处理启动应用程序基本数据" class="headerlink" title="1. ATMS处理启动应用程序基本数据"></a>1. ATMS处理启动应用程序基本数据</h5><p><img src="https://s2.loli.net/2023/12/26/jUGaBbK5StdwWr2.jpg"></p>
<p>由根Activity启动流程可知，应用程序进程不存在时，会通过ActivityTaskManagerService#startProcessAsync()创建新进程。</p>
<p>ATMS想要启动应用程序进程，就需要向Zygote进程发送创建应用程序进程的请求，ATMS会通过调用startProcessLocked()向Zygote进程发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startProcessAsync</span><span class="params">(ActivityRecord activity, <span class="type">boolean</span> knownToBeDead, <span class="type">boolean</span> isTop,</span></span><br><span class="line"><span class="params">        String hostingType)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">m</span> <span class="operator">=</span> PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,</span><br><span class="line">                mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,</span><br><span class="line">                isTop, hostingType, activity.intent.getComponent());</span><br><span class="line">        mH.sendMessage(m);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ActivityManagerInternal::startProcess，”::”是Java8新增特性，相当于调用了ActivityManagerInternal的startProcess()方法。而ActivityManagerInternal是一个抽象类，它是Activity管理器本地服务接口，它的实现为AMS的内部类LocalService。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java$LocalService</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startProcess</span><span class="params">(String processName, ApplicationInfo info, <span class="type">boolean</span> knownToBeDead,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> isTop, String hostingType, ComponentName hostingName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">synchronized</span> (ActivityManagerService.<span class="built_in">this</span>) &#123;</span><br><span class="line">            startProcessLocked(processName, info, knownToBeDead, <span class="number">0</span> <span class="comment">/* intentFlags */</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">HostingRecord</span>(hostingType, hostingName, isTop),</span><br><span class="line">                    ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, <span class="literal">false</span> <span class="comment">/* allowWhileBooting */</span>,</span><br><span class="line">                    <span class="literal">false</span> <span class="comment">/* isolated */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着调用AMS的startProcessLocked()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"><span class="keyword">final</span> ProcessRecord <span class="title function_">startProcessLocked</span><span class="params">(String processName,</span></span><br><span class="line"><span class="params">        ApplicationInfo info, <span class="type">boolean</span> knownToBeDead, <span class="type">int</span> intentFlags,</span></span><br><span class="line"><span class="params">        HostingRecord hostingRecord, <span class="type">int</span> zygotePolicyFlags, <span class="type">boolean</span> allowWhileBooting,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> isolated)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,</span><br><span class="line">            hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>,</span><br><span class="line">            <span class="literal">false</span> <span class="comment">/* isSdkSandbox */</span>, <span class="number">0</span> <span class="comment">/* sdkSandboxClientAppUid */</span>,</span><br><span class="line">            <span class="literal">null</span> <span class="comment">/* sdkSandboxClientAppPackage */</span>,</span><br><span class="line">            <span class="literal">null</span> <span class="comment">/* ABI override */</span>, <span class="literal">null</span> <span class="comment">/* entryPoint */</span>,</span><br><span class="line">            <span class="literal">null</span> <span class="comment">/* entryPointArgs */</span>, <span class="literal">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将启动进程任务转发给mProcessList，mProcessList是一个ProcessList对象，ProcessList是处理Activity进程的管理类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span><br><span class="line">ProcessRecord <span class="title function_">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> knownToBeDead, <span class="type">int</span> intentFlags, HostingRecord hostingRecord,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> zygotePolicyFlags, <span class="type">boolean</span> allowWhileBooting, <span class="type">boolean</span> isolated, <span class="type">int</span> isolatedUid,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> isSdkSandbox, <span class="type">int</span> sdkSandboxUid, String sdkSandboxClientAppPackage,</span></span><br><span class="line"><span class="params">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="literal">null</span>) &#123;</span><br><span class="line">        checkSlow(startTime, <span class="string">&quot;startProcess: creating new process record&quot;</span>);</span><br><span class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid, isSdkSandbox,</span><br><span class="line">                sdkSandboxUid, sdkSandboxClientAppPackage, hostingRecord);  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (app == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Failed making new process record for &quot;</span></span><br><span class="line">                    + processName + <span class="string">&quot;/&quot;</span> + info.uid + <span class="string">&quot; isolated=&quot;</span> + isolated);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        app.mErrorState.setCrashHandler(crashHandler);</span><br><span class="line">        app.setIsolatedEntryPoint(entryPoint);</span><br><span class="line">        app.setIsolatedEntryPointArgs(entryPointArgs);</span><br><span class="line">        <span class="keyword">if</span> (predecessor != <span class="literal">null</span>) &#123;</span><br><span class="line">            app.mPredecessor = predecessor;</span><br><span class="line">            predecessor.mSuccessor = app;</span><br><span class="line">        &#125;</span><br><span class="line">        checkSlow(startTime, <span class="string">&quot;startProcess: done creating new process record&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span></span><br><span class="line">            startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);</span><br><span class="line">    checkSlow(startTime, <span class="string">&quot;startProcess: done starting proc!&quot;</span>);  <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">return</span> success ? app : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建了ProcessRecord对象，它保存了当前正在运行的特定进程的完整信息，也就是需要启动的应用程序进程。接着注释2处继续调用startProcessLocked()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">startProcessLocked</span><span class="params">(ProcessRecord app, HostingRecord hostingRecord,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> zygotePolicyFlags, String abiOverride)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(app, hostingRecord, zygotePolicyFlags,</span><br><span class="line">            <span class="literal">false</span> <span class="comment">/* disableHiddenApiChecks */</span>, <span class="literal">false</span> <span class="comment">/* disableTestApiChecks */</span>,</span><br><span class="line">            abiOverride);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">startProcessLocked</span><span class="params">(ProcessRecord app, HostingRecord hostingRecord,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> zygotePolicyFlags, <span class="type">boolean</span> disableHiddenApiChecks, <span class="type">boolean</span> disableTestApiChecks,</span></span><br><span class="line"><span class="params">        String abiOverride)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> app.uid;  <span class="comment">// 1</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</span><br><span class="line">            ...</span><br><span class="line">            gids = computeGidsForProcess(mountExternal, uid, permGids, externalStorageAccess);  <span class="comment">// 2</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">entryPoint</span> <span class="operator">=</span> <span class="string">&quot;android.app.ActivityThread&quot;</span>;  <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,</span><br><span class="line">                runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,</span><br><span class="line">                instructionSet, invokeWith, startUptime, startElapsedTime);  <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处获取了应用程序的用户id；</p>
<p>注释2处获取了用户组id；</p>
<p>注释3处给entrypoint赋值为”android.app.ActivityThread”，这个值就是应用程序进程主线程的类名；</p>
<p>注释4处接着调用startProcessLocked()；</p>
<p>此外，还设置了App进程挂载外部空间的模式、RuntimeFlags、abi架构等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">startProcessLocked</span><span class="params">(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> uid, <span class="type">int</span>[] gids, <span class="type">int</span> runtimeFlags, <span class="type">int</span> zygotePolicyFlags, <span class="type">int</span> mountExternal,</span></span><br><span class="line"><span class="params">        String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> startUptime, <span class="type">long</span> startElapsedTime)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mService.mConstants.FLAG_PROCESS_START_ASYNC) &#123;  <span class="comment">// 异步启动进程</span></span><br><span class="line">        ...</span><br><span class="line">        mService.mProcStartHandler.post(() -&gt; handleProcessStart(</span><br><span class="line">                app, entryPoint, gids, runtimeFlags, zygotePolicyFlags, mountExternal,</span><br><span class="line">                requiredAbi, instructionSet, invokeWith, startSeq));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Process.<span class="type">ProcessStartResult</span> <span class="variable">startResult</span> <span class="operator">=</span> startProcess(hostingRecord,</span><br><span class="line">                    entryPoint, app,</span><br><span class="line">                    uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,</span><br><span class="line">                    requiredAbi, instructionSet, invokeWith, startUptime);</span><br><span class="line">            handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,</span><br><span class="line">                    startSeq, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app.getPid() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对AMS采用同步或者异步的启动方式做了一些工作，最终都会调用startProcess()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span><br><span class="line"><span class="keyword">private</span> Process.ProcessStartResult <span class="title function_">startProcess</span><span class="params">(HostingRecord hostingRecord, String entryPoint,</span></span><br><span class="line"><span class="params">        ProcessRecord app, <span class="type">int</span> uid, <span class="type">int</span>[] gids, <span class="type">int</span> runtimeFlags, <span class="type">int</span> zygotePolicyFlags,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> mountExternal, String seInfo, String requiredAbi, String instructionSet,</span></span><br><span class="line"><span class="params">        String invokeWith, <span class="type">long</span> startTime)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> Process.ProcessStartResult startResult;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (hostingRecord.usesWebviewZygote()) &#123;  <span class="comment">// 1</span></span><br><span class="line">            startResult = startWebView(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="literal">null</span>, app.info.packageName,</span><br><span class="line">                    app.getDisabledCompatChanges(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;PROC_START_SEQ_IDENT + app.getStartSeq()&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hostingRecord.usesAppZygote()) &#123;  <span class="comment">// 2</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">AppZygote</span> <span class="variable">appZygote</span> <span class="operator">=</span> createAppZygoteForProcessIfNeeded(app);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We can&#x27;t isolate app data and storage data as parent zygote already did that.</span></span><br><span class="line">            startResult = appZygote.getProcess().start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="literal">null</span>, app.info.packageName,</span><br><span class="line">                    <span class="comment">/*zygotePolicyFlags=*/</span> ZYGOTE_POLICY_FLAG_EMPTY, isTopApp,</span><br><span class="line">                    app.getDisabledCompatChanges(), pkgDataInfoMap, allowlistedAppDataInfoMap,</span><br><span class="line">                    <span class="literal">false</span>, <span class="literal">false</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;PROC_START_SEQ_IDENT + app.getStartSeq()&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 3</span></span><br><span class="line">            regularZygote = <span class="literal">true</span>;</span><br><span class="line">            startResult = Process.start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, invokeWith, app.info.packageName, zygotePolicyFlags,</span><br><span class="line">                    isTopApp, app.getDisabledCompatChanges(), pkgDataInfoMap,</span><br><span class="line">                    allowlistedAppDataInfoMap, bindMountAppsData, bindMountAppStorageDirs,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;PROC_START_SEQ_IDENT + app.getStartSeq()&#125;);</span><br><span class="line">            <span class="comment">// By now the process group should have been created by zygote.</span></span><br><span class="line">            app.mProcessGroupCreated = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> startResult;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>startProcess()会判断由哪个Zygote来创建我们的App进程。一般情况下，不指定时，使用默认Zygote。</p>
<p>注释1处由WebviewZygote创建进程；</p>
<p>注释2处由AppZygote创建进程；</p>
<p>注释3处由默认的Zygote创建进程，调用Process类的start()方法，Process是用于管理操作系统进程的工具类。</p>
<h5 id="2-Process处理启动参数到Zygote进程"><a href="#2-Process处理启动参数到Zygote进程" class="headerlink" title="2. Process处理启动参数到Zygote进程"></a>2. Process处理启动参数到Zygote进程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/Process.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ZygoteProcess</span> <span class="variable">ZYGOTE_PROCESS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZygoteProcess</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ProcessStartResult <span class="title function_">start</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> String processClass,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> <span class="keyword">final</span> String niceName,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> uid, <span class="type">int</span> gid, <span class="meta">@Nullable</span> <span class="type">int</span>[] gids,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> runtimeFlags,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> mountExternal,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> targetSdkVersion,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String seInfo,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@NonNull</span> String abi,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String instructionSet,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String appDataDir,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String invokeWith,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String packageName,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> zygotePolicyFlags,</span></span><br><span class="line"><span class="params">                                       <span class="type">boolean</span> isTopApp,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> <span class="type">long</span>[] disabledCompatChanges,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                               pkgDataInfoMap,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                               whitelistedDataInfoMap,</span></span><br><span class="line"><span class="params">                                       <span class="type">boolean</span> bindMountAppsData,</span></span><br><span class="line"><span class="params">                                       <span class="type">boolean</span> bindMountAppStorageDirs,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Nullable</span> String[] zygoteArgs)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, invokeWith, packageName,</span><br><span class="line">                zygotePolicyFlags, isTopApp, disabledCompatChanges,</span><br><span class="line">                pkgDataInfoMap, whitelistedDataInfoMap, bindMountAppsData,</span><br><span class="line">                bindMountAppStorageDirs, zygoteArgs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Process#start()方法把进程的启动工作转发给了ZygoteProcess。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Process.ProcessStartResult <span class="title function_">start</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> String processClass,</span></span><br><span class="line"><span class="params">                                              <span class="keyword">final</span> String niceName,</span></span><br><span class="line"><span class="params">                                              <span class="type">int</span> uid, <span class="type">int</span> gid, <span class="meta">@Nullable</span> <span class="type">int</span>[] gids,</span></span><br><span class="line"><span class="params">                                              <span class="type">int</span> runtimeFlags, <span class="type">int</span> mountExternal,</span></span><br><span class="line"><span class="params">                                              <span class="type">int</span> targetSdkVersion,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String seInfo,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@NonNull</span> String abi,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String instructionSet,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String appDataDir,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String invokeWith,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String packageName,</span></span><br><span class="line"><span class="params">                                              <span class="type">int</span> zygotePolicyFlags,</span></span><br><span class="line"><span class="params">                                              <span class="type">boolean</span> isTopApp,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> <span class="type">long</span>[] disabledCompatChanges,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                                      pkgDataInfoMap,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                                      allowlistedDataInfoList,</span></span><br><span class="line"><span class="params">                                              <span class="type">boolean</span> bindMountAppsData,</span></span><br><span class="line"><span class="params">                                              <span class="type">boolean</span> bindMountAppStorageDirs,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Nullable</span> String[] zygoteArgs)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO (chriswailes): Is there a better place to check this value?</span></span><br><span class="line">    <span class="keyword">if</span> (fetchUsapPoolEnabledPropWithMinInterval()) &#123;</span><br><span class="line">        informZygotesOfUsapPoolStatus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, invokeWith, <span class="comment">/*startChildZygote=*/</span> <span class="literal">false</span>,</span><br><span class="line">                packageName, zygotePolicyFlags, isTopApp, disabledCompatChanges,</span><br><span class="line">                pkgDataInfoMap, allowlistedDataInfoList, bindMountAppsData,</span><br><span class="line">                bindMountAppStorageDirs, zygoteArgs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ZygoteProcess#start()又调用了startViaZygote()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="line"><span class="keyword">private</span> Process.ProcessStartResult <span class="title function_">startViaZygote</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> String processClass,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> <span class="keyword">final</span> String niceName,</span></span><br><span class="line"><span class="params">                                                  <span class="keyword">final</span> <span class="type">int</span> uid, <span class="keyword">final</span> <span class="type">int</span> gid,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> <span class="keyword">final</span> <span class="type">int</span>[] gids,</span></span><br><span class="line"><span class="params">                                                  <span class="type">int</span> runtimeFlags, <span class="type">int</span> mountExternal,</span></span><br><span class="line"><span class="params">                                                  <span class="type">int</span> targetSdkVersion,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String seInfo,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@NonNull</span> String abi,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String instructionSet,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String appDataDir,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String invokeWith,</span></span><br><span class="line"><span class="params">                                                  <span class="type">boolean</span> startChildZygote,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String packageName,</span></span><br><span class="line"><span class="params">                                                  <span class="type">int</span> zygotePolicyFlags,</span></span><br><span class="line"><span class="params">                                                  <span class="type">boolean</span> isTopApp,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> <span class="type">long</span>[] disabledCompatChanges,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                                          pkgDataInfoMap,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span><br><span class="line"><span class="params">                                                          allowlistedDataInfoList,</span></span><br><span class="line"><span class="params">                                                  <span class="type">boolean</span> bindMountAppsData,</span></span><br><span class="line"><span class="params">                                                  <span class="type">boolean</span> bindMountAppStorageDirs,</span></span><br><span class="line"><span class="params">                                                  <span class="meta">@Nullable</span> String[] extraArgs)</span></span><br><span class="line">                                                  <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</span><br><span class="line">    ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--runtime-args&quot;</span>);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--setuid=&quot;</span> + uid);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--setgid=&quot;</span> + gid);</span><br><span class="line">    argsForZygote.add(<span class="string">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class="line">    ...  <span class="comment">// 设置一系列参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line">        <span class="comment">// The USAP pool can not be used if the application will not use the systems graphics</span></span><br><span class="line">        <span class="comment">// driver.  If that driver is requested use the Zygote application start path.</span></span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),</span><br><span class="line">                                          zygotePolicyFlags,</span><br><span class="line">                                          argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置启动参数，然后调用zygoteSendArgsAndGetResult()，该方法的第一个参数又调用了openZygoteSocketIfNeeded()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="line"><span class="keyword">private</span> ZygoteState <span class="title function_">openZygoteSocketIfNeeded</span><span class="params">(String abi)</span> <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        attemptConnectionToPrimaryZygote();  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class="line">            <span class="keyword">return</span> primaryZygoteState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mZygoteSecondarySocketAddress != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The primary zygote didn&#x27;t match. Try the secondary.</span></span><br><span class="line">            attemptConnectionToSecondaryZygote();  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class="line">                <span class="keyword">return</span> secondaryZygoteState;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZygoteStartFailedEx</span>(<span class="string">&quot;Error connecting to zygote&quot;</span>, ioe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZygoteStartFailedEx</span>(<span class="string">&quot;Unsupported zygote ABI: &quot;</span> + abi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Process.ProcessStartResult <span class="title function_">zygoteSendArgsAndGetResult</span><span class="params">(</span></span><br><span class="line"><span class="params">        ZygoteState zygoteState, <span class="type">int</span> zygotePolicyFlags, <span class="meta">@NonNull</span> ArrayList&lt;String&gt; args)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldAttemptUsapLaunch(zygotePolicyFlags, args)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> attemptUsapSendArgsAndGetResult(zygoteState, msgStr);  <span class="comment">// 3</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);  <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1和注释2处，如果连接Zygote主模式返回的ZygoteState与启动应用程序所需的abi不匹配，则连接Zygote辅模式。两个方法逻辑基本相同。</p>
<p>注释3和注释4处都传入了zygoteState，ZygoteState是ZygoteProcess的静态内部类，保存了与Zygote进行通信的状态，而它的返回是由openZygoteSocketIfNeeded()处理的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/os/ZygoteProcess.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">attemptConnectionToPrimaryZygote</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (primaryZygoteState == <span class="literal">null</span> || primaryZygoteState.isClosed()) &#123;</span><br><span class="line">        primaryZygoteState =</span><br><span class="line">                ZygoteState.connect(mZygoteSocketAddress, mUsapPoolSocketAddress);  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">        maybeSetApiDenylistExemptions(primaryZygoteState, <span class="literal">false</span>);</span><br><span class="line">        maybeSetHiddenApiAccessLogSampleRate(primaryZygoteState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Process.ProcessStartResult <span class="title function_">attemptZygoteSendArgsAndGetResult</span><span class="params">(</span></span><br><span class="line"><span class="params">        ZygoteState zygoteState, String msgStr)</span> <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取服务端（Zygote）输出流</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BufferedWriter</span> <span class="variable">zygoteWriter</span> <span class="operator">=</span> zygoteState.mZygoteOutputWriter;</span><br><span class="line">        <span class="comment">// 获取服务端（Zygote）输入流</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">DataInputStream</span> <span class="variable">zygoteInputStream</span> <span class="operator">=</span> zygoteState.mZygoteInputStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将参数写入Zygote</span></span><br><span class="line">        zygoteWriter.write(msgStr);</span><br><span class="line">        zygoteWriter.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always read the entire result from the input stream to avoid leaving</span></span><br><span class="line">        <span class="comment">// bytes in the stream for future process starts to accidentally stumble</span></span><br><span class="line">        <span class="comment">// upon.</span></span><br><span class="line">        Process.<span class="type">ProcessStartResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Process</span>.ProcessStartResult();</span><br><span class="line">        <span class="comment">// 获取Zygote返回的结果</span></span><br><span class="line">        result.pid = zygoteInputStream.readInt();</span><br><span class="line">        result.usingWrapper = zygoteInputStream.readBoolean();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZygoteStartFailedEx</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        zygoteState.close();</span><br><span class="line">        Log.e(LOG_TAG, <span class="string">&quot;IO Exception while communicating with Zygote - &quot;</span></span><br><span class="line">                + ex.toString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZygoteStartFailedEx</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处调用ZygoteState的connect()方法打开Socket连接，mZygoteSocketAddress是名称为zygote的Socket服务。</p>
<p>attemptZygoteSendArgsAndGetResult()主要是通过socket通道向Zygote进程发送一个参数列表，然后进入阻塞等待状态，直到远端的socket服务端发送回来新创建的进程pid才返回。</p>
<h4 id="Zygote接收请求并创建应用程序进程"><a href="#Zygote接收请求并创建应用程序进程" class="headerlink" title="Zygote接收请求并创建应用程序进程"></a>Zygote接收请求并创建应用程序进程</h4><p><img src="https://s2.loli.net/2023/12/26/atMdRcDh6j5SHEJ.jpg"></p>
<h5 id="1-Zygote接收请求"><a href="#1-Zygote接收请求" class="headerlink" title="1. Zygote接收请求"></a>1. Zygote接收请求</h5><p>Zygote是通过fork自身来创建其他进程的。在ZygoteInit#main()中根据传递进来的参数，判断是启动什么类型的进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">    <span class="type">ZygoteServer</span> <span class="variable">zygoteServer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    Runnable caller;  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">startSystemServer</span> <span class="operator">=</span> <span class="literal">false</span>;  <span class="comment">// 2</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">zygoteSocketName</span> <span class="operator">=</span> <span class="string">&quot;zygote&quot;</span>;  <span class="comment">// 3</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">abiList</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">enableLazyPreload</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;  <span class="comment">// 4</span></span><br><span class="line">                startSystemServer = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                enableLazyPreload = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isPrimaryZygote</span> <span class="operator">=</span> zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        Zygote.initNativeState(isPrimaryZygote);  <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        zygoteServer = <span class="keyword">new</span> <span class="title class_">ZygoteServer</span>(isPrimaryZygote);  <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);  <span class="comment">// 7</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">            <span class="comment">// child (system_server) process.</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">        <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">        caller = zygoteServer.runSelectLoop(abiList);  <span class="comment">// 8</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;System zygote died with fatal exception&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (zygoteServer != <span class="literal">null</span>) &#123;</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">    <span class="comment">// command.</span></span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="literal">null</span>) &#123;</span><br><span class="line">        caller.run();  <span class="comment">// 9</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建了一个Runnable类型的请求对象代表此次请求Zygote获取应用进程的对象；</p>
<p>注释2、4、7处如果是SystemServer进程，就启动SystemServer，如果不是就启动其他应用程序进程；</p>
<p>注释3处设置Socket连接名称为zygote；</p>
<p>注释5处初始化Zygote的状态环境，包括支持套接字的环境、安全环境等；</p>
<p>注释6处创建了ZygoteServer对象，它可以理解为Zygote支持Socket进程通信的服务端；</p>
<p>注释8处的runSelectLoop()是Zygote进程等待接收AMS请求启动应用程序进程的关键方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</span><br><span class="line">Runnable <span class="title function_">runSelectLoop</span><span class="params">(String abiList)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (pollReturnValue == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">while</span> (--pollIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (pollIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Zygote server socket</span></span><br><span class="line">                    <span class="type">ZygoteConnection</span> <span class="variable">newPeer</span> <span class="operator">=</span> acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(newPeer);</span><br><span class="line">                    socketFDs.add(newPeer.getFileDescriptor());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) &#123;</span><br><span class="line">                    <span class="comment">// Session socket accepted from the Zygote server socket</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">ZygoteConnection</span> <span class="variable">connection</span> <span class="operator">=</span> peers.get(pollIndex);</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">multipleForksOK</span> <span class="operator">=</span> !isUsapPoolEnabled()</span><br><span class="line">                                &amp;&amp; ZygoteHooks.isIndefiniteThreadSuspensionSafe();</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">command</span> <span class="operator">=</span></span><br><span class="line">                                connection.processCommand(<span class="built_in">this</span>, multipleForksOK);  <span class="comment">// 1</span></span><br><span class="line">                        ...</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有AMS的请求数据到来时，会调用注释1处的代码，即调用ZygoteConnection#processCommand()。</p>
<h5 id="2-获取应用程序进程"><a href="#2-获取应用程序进程" class="headerlink" title="2. 获取应用程序进程"></a>2. 获取应用程序进程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span><br><span class="line">Runnable <span class="title function_">processCommand</span><span class="params">(ZygoteServer zygoteServer, <span class="type">boolean</span> multipleOK)</span> &#123;</span><br><span class="line">    ZygoteArguments parsedArgs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ZygoteCommandBuffer</span> <span class="variable">argBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZygoteCommandBuffer</span>(mSocket)) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                parsedArgs = ZygoteArguments.getInstance(argBuffer);</span><br><span class="line">                <span class="comment">// Keep argBuffer around, since we need it to fork.</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;IOException on command socket&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parsedArgs.mInvokeWith != <span class="literal">null</span> || parsedArgs.mStartChildZygote</span><br><span class="line">                    || !multipleOK || peer.getUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">                <span class="comment">// Continue using old code for now. <span class="doctag">TODO:</span> Handle these cases in the other path.</span></span><br><span class="line">                pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid,</span><br><span class="line">                        parsedArgs.mGids, parsedArgs.mRuntimeFlags, rlimits,</span><br><span class="line">                        parsedArgs.mMountExternal, parsedArgs.mSeInfo, parsedArgs.mNiceName,</span><br><span class="line">                        fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,</span><br><span class="line">                        parsedArgs.mInstructionSet, parsedArgs.mAppDataDir,</span><br><span class="line">                        parsedArgs.mIsTopApp, parsedArgs.mPkgDataInfoList,</span><br><span class="line">                        parsedArgs.mAllowlistedDataInfoList, parsedArgs.mBindMountAppDataDirs,</span><br><span class="line">                        parsedArgs.mBindMountAppStorageDirs);  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// in child</span></span><br><span class="line">                        zygoteServer.setForkChild();</span><br><span class="line"></span><br><span class="line">                        zygoteServer.closeServerSocket();</span><br><span class="line">                        IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">                        serverPipeFd = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> handleChildProc(parsedArgs, childPipeFd,</span><br><span class="line">                                parsedArgs.mStartChildZygote);  <span class="comment">// 2</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处fork子进程，参数为parsedArgs中存储的应用进程启动参数，返回值为pid。如果pid为0，说明当前代码逻辑运行在新创建的子进程（应用程序进程）中，这时就会调用注释2处handleChildProc()方法来处理应用程序进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/Zygote.java</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">forkAndSpecialize</span><span class="params">(<span class="type">int</span> uid, <span class="type">int</span> gid, <span class="type">int</span>[] gids, <span class="type">int</span> runtimeFlags,</span></span><br><span class="line"><span class="params">        <span class="type">int</span>[][] rlimits, <span class="type">int</span> mountExternal, String seInfo, String niceName, <span class="type">int</span>[] fdsToClose,</span></span><br><span class="line"><span class="params">        <span class="type">int</span>[] fdsToIgnore, <span class="type">boolean</span> startChildZygote, String instructionSet, String appDataDir,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> isTopApp, String[] pkgDataInfoList, String[] allowlistedDataInfoList,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> bindMountAppDataDirs, <span class="type">boolean</span> bindMountAppStorageDirs)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> nativeForkAndSpecialize(</span><br><span class="line">            uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,</span><br><span class="line">            fdsToIgnore, startChildZygote, instructionSet, appDataDir, isTopApp,</span><br><span class="line">            pkgDataInfoList, allowlistedDataInfoList, bindMountAppDataDirs,</span><br><span class="line">            bindMountAppStorageDirs);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span><br><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">handleChildProc</span><span class="params">(ZygoteArguments parsedArgs,</span></span><br><span class="line"><span class="params">        FileDescriptor pipeFd, <span class="type">boolean</span> isZygote)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.mInvokeWith != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isZygote) &#123;</span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                    parsedArgs.mDisabledCompatChanges,</span><br><span class="line">                    parsedArgs.mRemainingArgs, <span class="literal">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.childZygoteInit(</span><br><span class="line">                    parsedArgs.mRemainingArgs  <span class="comment">/* classLoader */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>forkAndSpecialize()会通过native方法nativeForkAndSpecialize()与底层通信fork应用程序进程。</p>
<p>handleChildProc()继续调用ZygoteInit#zygoteInit()方法。</p>
<h5 id="3-创建应用程序的ActivityThread"><a href="#3-创建应用程序的ActivityThread" class="headerlink" title="3. 创建应用程序的ActivityThread"></a>3. 创建应用程序的ActivityThread</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Runnable <span class="title function_">zygoteInit</span><span class="params">(<span class="type">int</span> targetSdkVersion, <span class="type">long</span>[] disabledCompatChanges,</span></span><br><span class="line"><span class="params">        String[] argv, ClassLoader classLoader)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    ZygoteInit.nativeZygoteInit();  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,</span><br><span class="line">            classLoader);  <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处会在新创建的应用程序进程中创建Binder线程池，当前应用程序就拥有了Binder通信的能力；</p>
<p>注释2处调用了RuntimeInit#applicationInit()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title function_">applicationInit</span><span class="params">(<span class="type">int</span> targetSdkVersion, <span class="type">long</span>[] disabledCompatChanges,</span></span><br><span class="line"><span class="params">        String[] argv, ClassLoader classLoader)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用findStaticMain()，其中的args.startClass是android.app.ActivityThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title function_">findStaticMain</span><span class="params">(String className, String[] argv,</span></span><br><span class="line"><span class="params">        ClassLoader classLoader)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cl = Class.forName(className, <span class="literal">true</span>, classLoader);  <span class="comment">// 1</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String[].class &#125;);  <span class="comment">// 2</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodAndArgsCaller</span>(m, argv);  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处通过反射获得了android.app.ActivityThread类；</p>
<p>注释2处获得了ActivityThread的main()方法，并将main()方法传入注释3处的MethodAndArgsCaller类的构造方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="comment">/** method to call */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** argument array */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> &#123;</span><br><span class="line">        mMethod = method;</span><br><span class="line">        mArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mMethod.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; mArgs &#125;);  <span class="comment">// 1</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该Runnable一路返回到本小节开头的注释9：<code>caller.run()</code>。caller.run()调用Method#invoke()，也就是ActivityThread#main()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">	...</span><br><span class="line">    <span class="type">ActivityThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityThread</span>();</span><br><span class="line">    thread.attach(<span class="literal">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ActivityThread是每个应用程序主线程的管理类。main()中创建了ActivityThread进程，并启动了消息循环队列，代表着当前进程的主线程已启动。</p>
<p>到此，应用程序进程启动完成。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="cltjvv1bk000t8q2u0cliga5m" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-广播的发送和接收过程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E5%B9%BF%E6%92%AD%E7%9A%84%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.577Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="广播的发送和接收过程"><a href="#广播的发送和接收过程" class="headerlink" title="广播的发送和接收过程"></a><center>广播的发送和接收过程</center></h2><blockquote>
<p>基于Android U，以无序广播为例</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/12/28/tWEzY5mDZ97FsCq.jpg"></p>
<h4 id="ContextImpl到AMS的调用过程"><a href="#ContextImpl到AMS的调用过程" class="headerlink" title="ContextImpl到AMS的调用过程"></a>ContextImpl到AMS的调用过程</h4><p>发送无序广播需要调用sendBroadcast()方法，它在ContextWrapper中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendBroadcast</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">    mBase.sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mBase具体指向就是ContextImpl。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendBroadcast</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    <span class="type">String</span> <span class="variable">resolvedType</span> <span class="operator">=</span> intent.resolveTypeIfNeeded(getContentResolver());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.prepareToLeaveProcess(<span class="built_in">this</span>);</span><br><span class="line">        ActivityManager.getService().broadcastIntentWithFeature(</span><br><span class="line">                mMainThread.getApplicationThread(), getAttributionTag(), intent, resolvedType,</span><br><span class="line">                <span class="literal">null</span>, Activity.RESULT_OK, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span> <span class="comment">/*excludedPermissions=*/</span>,</span><br><span class="line">                <span class="literal">null</span>, AppOpsManager.OP_NONE, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">false</span>, getUserId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终会调用AMS的broadcastIntentWithFeature()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">broadcastIntentWithFeature</span><span class="params">(IApplicationThread caller, String callingFeatureId,</span></span><br><span class="line"><span class="params">        Intent intent, String resolvedType, IIntentReceiver resultTo,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> resultCode, String resultData, Bundle resultExtras,</span></span><br><span class="line"><span class="params">        String[] requiredPermissions, String[] excludedPermissions,</span></span><br><span class="line"><span class="params">        String[] excludedPackages, <span class="type">int</span> appOp, Bundle bOptions,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> serialized, <span class="type">boolean</span> sticky, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">&quot;broadcastIntent&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        intent = verifyBroadcastLocked(intent);  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">callerApp</span> <span class="operator">=</span> getRecordForAppLOSP(caller);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingPid</span> <span class="operator">=</span> Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingUid</span> <span class="operator">=</span> Binder.getCallingUid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re delivering the result to the caller</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">resultToApp</span> <span class="operator">=</span> callerApp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Permission regimes around sender-supplied broadcast options.</span></span><br><span class="line">        enforceBroadcastOptionPermissionsInternal(bOptions, callingUid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> broadcastIntentLocked(callerApp,</span><br><span class="line">                    callerApp != <span class="literal">null</span> ? callerApp.info.packageName : <span class="literal">null</span>, callingFeatureId,</span><br><span class="line">                    intent, resolvedType, resultToApp, resultTo, resultCode, resultData,</span><br><span class="line">                    resultExtras, requiredPermissions, excludedPermissions, excludedPackages,</span><br><span class="line">                    appOp, bOptions, serialized, sticky, callingPid, callingUid, callingUid,</span><br><span class="line">                    callingPid, userId, BackgroundStartPrivileges.NONE, <span class="literal">null</span>, <span class="literal">null</span>);  <span class="comment">// 2</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处验证广播是否合法；</p>
<p>注释2处调用broadcastIntentLocked()。</p>
<ol>
<li><p>verifyBroadcastLocked()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"><span class="keyword">final</span> Intent <span class="title function_">verifyBroadcastLocked</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="literal">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="literal">true</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;File descriptors passed in Intent&quot;</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">	<span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> intent.getFlags();  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mProcessesReady) &#123;</span><br><span class="line">        <span class="comment">// if the caller really truly claims to know what they&#x27;re doing, go</span></span><br><span class="line">        <span class="comment">// ahead and allow the broadcast without launching any receivers</span></span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT) != <span class="number">0</span>) &#123;  <span class="comment">// 3</span></span><br><span class="line">            <span class="comment">// This will be turned into a FLAG_RECEIVER_REGISTERED_ONLY later on if needed.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flags&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY) == <span class="number">0</span>) &#123;  <span class="comment">// 4</span></span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Attempt to launch receivers of broadcast intent &quot;</span> + intent</span><br><span class="line">                    + <span class="string">&quot; before boot completion&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot broadcast before boot completed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>verifyBroadcastLocked()方法主要验证广播是否合法，注释1处验证intent是否有文件描述符。注释2处获得intent中的flag。注释3处如果系统正在启动过程中，判断如果flag设置为FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT（启动检查时只接受动态注册的广播接收者）则不做处理，如果不是则在注释4处判断如果flag没有设置为FLAG_RECEIVER_REGISTERED_ONLY（只接受动态注册的广播接收者）则会抛出异常。</p>
</li>
<li><p>broadcastIntentLocked()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">broadcastIntentLocked</span><span class="params">(ProcessRecord callerApp, String callerPackage,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> String callerFeatureId, Intent intent, String resolvedType,</span></span><br><span class="line"><span class="params">        ProcessRecord resultToApp, IIntentReceiver resultTo, <span class="type">int</span> resultCode, String resultData,</span></span><br><span class="line"><span class="params">        Bundle resultExtras, String[] requiredPermissions,</span></span><br><span class="line"><span class="params">        String[] excludedPermissions, String[] excludedPackages, <span class="type">int</span> appOp, Bundle bOptions,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">int</span> callingPid, <span class="type">int</span> callingUid,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> realCallingUid, <span class="type">int</span> realCallingPid, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        BackgroundStartPrivileges backgroundStartPrivileges,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> <span class="type">int</span>[] broadcastAllowList,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> BiFunction&lt;Integer, Bundle, Bundle&gt; filterExtrasForReceiver)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">cookie</span> <span class="operator">=</span> BroadcastQueue.traceBegin(<span class="string">&quot;broadcastIntentLockedTraced&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> broadcastIntentLockedTraced(callerApp, callerPackage, callerFeatureId,</span><br><span class="line">            intent, resolvedType, resultToApp, resultTo, resultCode, resultData, resultExtras,</span><br><span class="line">            requiredPermissions, excludedPermissions, excludedPackages, appOp,</span><br><span class="line">            BroadcastOptions.fromBundleNullable(bOptions), ordered, sticky,</span><br><span class="line">            callingPid, callingUid, realCallingUid, realCallingPid, userId,</span><br><span class="line">            backgroundStartPrivileges, broadcastAllowList, filterExtrasForReceiver);</span><br><span class="line">    BroadcastQueue.traceEnd(cookie);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">broadcastIntentLockedTraced</span><span class="params">(ProcessRecord callerApp, String callerPackage,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> String callerFeatureId, Intent intent, String resolvedType,</span></span><br><span class="line"><span class="params">        ProcessRecord resultToApp, IIntentReceiver resultTo, <span class="type">int</span> resultCode, String resultData,</span></span><br><span class="line"><span class="params">        Bundle resultExtras, String[] requiredPermissions,</span></span><br><span class="line"><span class="params">        String[] excludedPermissions, String[] excludedPackages, <span class="type">int</span> appOp,</span></span><br><span class="line"><span class="params">        BroadcastOptions brOptions, <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">int</span> callingPid,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> callingUid, <span class="type">int</span> realCallingUid, <span class="type">int</span> realCallingPid, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        BackgroundStartPrivileges backgroundStartPrivileges,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> <span class="type">int</span>[] broadcastAllowList,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> BiFunction&lt;Integer, Bundle, Bundle&gt; filterExtrasForReceiver)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!ordered &amp;&amp; NR &gt; <span class="number">0</span> &amp;&amp; !mEnableModernQueue) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BroadcastQueue</span> <span class="variable">queue</span> <span class="operator">=</span> broadcastQueueForIntent(intent);</span><br><span class="line">        <span class="type">BroadcastRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastRecord</span>(queue, intent, callerApp, callerPackage,</span><br><span class="line">                callerFeatureId, callingPid, callingUid, callerInstantApp, resolvedType,</span><br><span class="line">                requiredPermissions, excludedPermissions, excludedPackages, appOp, brOptions,</span><br><span class="line">                registeredReceivers, resultToApp, resultTo, resultCode, resultData,</span><br><span class="line">                resultExtras, ordered, sticky, <span class="literal">false</span>, userId,</span><br><span class="line">                backgroundStartPrivileges, timeoutExempt, filterExtrasForReceiver,</span><br><span class="line">                callerAppProcessState);  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">&quot;Enqueueing parallel broadcast &quot;</span> + r);</span><br><span class="line">        queue.enqueueBroadcastLocked(r);  <span class="comment">// 2</span></span><br><span class="line">        registeredReceivers = <span class="literal">null</span>;</span><br><span class="line">        NR = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ((receivers != <span class="literal">null</span> &amp;&amp; receivers.size() &gt; <span class="number">0</span>)</span><br><span class="line">            || resultTo != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">BroadcastRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastRecord</span>(queue, intent, callerApp, callerPackage,</span><br><span class="line">                callerFeatureId, callingPid, callingUid, callerInstantApp, resolvedType,</span><br><span class="line">                requiredPermissions, excludedPermissions, excludedPackages, appOp, brOptions,</span><br><span class="line">                receivers, resultToApp, resultTo, resultCode, resultData, resultExtras,</span><br><span class="line">                ordered, sticky, <span class="literal">false</span>, userId,</span><br><span class="line">                backgroundStartPrivileges, timeoutExempt, filterExtrasForReceiver,</span><br><span class="line">                callerAppProcessState);  <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">&quot;Enqueueing ordered broadcast &quot;</span> + r);</span><br><span class="line">        queue.enqueueBroadcastLocked(r);  <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ActivityManager.BROADCAST_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>broadcastIntentLockedTraced代码较多，主要做了以下几件事情：</p>
<ol>
<li>设置intent，处理不同的action；</li>
<li>粘性广播的处理；</li>
<li>发送动态注册的无序广播列表（注释1、2）；</li>
<li>合并动态注册的有序广播列表和静态注册的广播列表，并发送（注释3、4）。</li>
</ol>
</li>
</ol>
<h4 id="AMS到BroadcastReceiver的调用过程"><a href="#AMS到BroadcastReceiver的调用过程" class="headerlink" title="AMS到BroadcastReceiver的调用过程"></a>AMS到BroadcastReceiver的调用过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueueBroadcastLocked</span><span class="params">(BroadcastRecord r)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Ordered broadcasts obviously need to be dispatched in serial order,</span></span><br><span class="line">    <span class="comment">// but this implementation expects all manifest receivers to also be</span></span><br><span class="line">    <span class="comment">// dispatched in a serial fashion</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">serialDispatch</span> <span class="operator">=</span> r.ordered;  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (!serialDispatch) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> (r.receivers != <span class="literal">null</span>) ? r.receivers.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.receivers.get(i) <span class="keyword">instanceof</span> ResolveInfo) &#123;</span><br><span class="line">                serialDispatch = <span class="literal">true</span>;  <span class="comment">// 2</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (serialDispatch) &#123;  <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BroadcastRecord</span> <span class="variable">oldRecord</span> <span class="operator">=</span></span><br><span class="line">                replacePending ? replaceOrderedBroadcastLocked(r) : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (oldRecord != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Replaced, fire the result-to receiver.</span></span><br><span class="line">            <span class="keyword">if</span> (oldRecord.resultTo != <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            enqueueOrderedBroadcastLocked(r);  <span class="comment">// 4</span></span><br><span class="line">            scheduleBroadcastsLocked();  <span class="comment">// 5</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">replaced</span> <span class="operator">=</span> replacePending</span><br><span class="line">                &amp;&amp; (replaceParallelBroadcastLocked(r) != <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// Note: We assume resultTo is null for non-ordered broadcasts.</span></span><br><span class="line">        <span class="keyword">if</span> (!replaced) &#123;</span><br><span class="line">            enqueueParallelBroadcastLocked(r);  <span class="comment">// 6</span></span><br><span class="line">            scheduleBroadcastsLocked();  <span class="comment">// 7</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处判断是否是有序发送；</p>
<p>注释2处如果是无序广播，但是是静态注册的广播接收者，serialDispatch会被设置为true，按照有序广播发送流程来发送；</p>
<p>注释3处有序发送，注释4处将BroadcastRecord添加到有序广播队列中，注释5处发送广播；</p>
<p>注释6处将BroadcastRecord添加到无序广播队列中，注释7处发送广播。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleBroadcastsLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mBroadcastsScheduled) &#123;  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="built_in">this</span>));  <span class="comment">// 2</span></span><br><span class="line">    mBroadcastsScheduled = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处如果已经处理过了，则返回；</p>
<p>注释2处向BroadcastHandler类型的mHandler对象发送了BROADCAST_INTENT_MSG类型的消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl$BroadcastHandler</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BroadcastHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BroadcastHandler</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> BROADCAST_INTENT_MSG: &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(</span><br><span class="line">                        TAG_BROADCAST, <span class="string">&quot;Received BROADCAST_INTENT_MSG [&quot;</span></span><br><span class="line">                        + mQueueName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">                processNextBroadcast(<span class="literal">true</span>);  <span class="comment">// 1</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BROADCAST_TIMEOUT_MSG: &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">                    broadcastTimeoutLocked(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处在handleMessage()方法中调用了processNextBroadcast()方法，方法对无序广播和有序广播分别进行处理，旨在将广播发送给广播接收者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processNextBroadcast</span><span class="params">(<span class="type">boolean</span> fromMsg)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">        processNextBroadcastLocked(fromMsg, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processNextBroadcastLocked</span><span class="params">(<span class="type">boolean</span> fromMsg, <span class="type">boolean</span> skipOomAdj)</span> &#123;</span><br><span class="line">    BroadcastRecord r;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (fromMsg) &#123;  <span class="comment">// 1</span></span><br><span class="line">        mBroadcastsScheduled = <span class="literal">false</span>;  <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, deliver any non-serialized broadcasts right away.</span></span><br><span class="line">    <span class="keyword">while</span> (mParallelBroadcasts.size() &gt; <span class="number">0</span>) &#123;  <span class="comment">// 3</span></span><br><span class="line">        r = mParallelBroadcasts.remove(<span class="number">0</span>);  <span class="comment">// 4</span></span><br><span class="line">        r.dispatchTime = SystemClock.uptimeMillis();</span><br><span class="line">        r.dispatchRealTime = SystemClock.elapsedRealtime();</span><br><span class="line">        r.dispatchClockTime = System.currentTimeMillis();</span><br><span class="line">        r.mIsReceiverAppRunning = <span class="literal">true</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> r.receivers.size();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> r.receivers.get(i);</span><br><span class="line">            ....</span><br><span class="line">            deliverToRegisteredReceiverLocked(r,</span><br><span class="line">                    (BroadcastFilter) target, <span class="literal">false</span>, i);  <span class="comment">// 5</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处，从前面BroadcastHandler#handleMessage()中我们得知传入的参数fromMsg的值为true，因此在注释2处将</p>
<p>mBroadcastsScheduled设置为false，表示对于此前发来的BROADCAST_INTENT_MSG类型的消息已经处理了。</p>
<p>注释3处的mParallelBroadcasts列表用来存储无序广播，通过while循环将mParallelBroadcasts列表中的无序广播发送给对应的广播接收者。在注释4处获取每一个mParallelBroadcasts列表中存储的BroadcastRecord类型的r对象。在注释5处将这些r对象描述的广播发送给对应的广播接收者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deliverToRegisteredReceiverLocked</span><span class="params">(BroadcastRecord r,</span></span><br><span class="line"><span class="params">        BroadcastFilter filter, <span class="type">boolean</span> ordered, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isInFullBackup</span> <span class="operator">=</span> (filter.receiverList.app != <span class="literal">null</span>)</span><br><span class="line">                &amp;&amp; filter.receiverList.app.isInFullBackup();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isKilled</span> <span class="operator">=</span> (filter.receiverList.app != <span class="literal">null</span>)</span><br><span class="line">                &amp;&amp; filter.receiverList.app.isKilled();</span><br><span class="line">        <span class="keyword">if</span> (isInFullBackup || isKilled) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            performReceiveLocked(r, filter.receiverList.app, filter.receiverList.receiver,</span><br><span class="line">                    prepareReceiverIntent(r.intent, filteredExtras), r.resultCode, r.resultData,</span><br><span class="line">                    r.resultExtras, r.ordered, r.initialSticky, r.shareIdentity, r.userId,</span><br><span class="line">                    filter.receiverList.uid, r.callingUid, r.callerPackage,</span><br><span class="line">                    r.dispatchTime - r.enqueueTime,</span><br><span class="line">                    r.receiverTime - r.dispatchTime, filter.getPriority(),</span><br><span class="line">                    filter.receiverList.app != <span class="literal">null</span></span><br><span class="line">                            ? filter.receiverList.app.mState.getCurProcState()</span><br><span class="line">                            : ActivityManager.PROCESS_STATE_UNKNOWN);  <span class="comment">// 1</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处接着调用performReceiveLocked()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/BroadcastQueueImpl.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performReceiveLocked</span><span class="params">(BroadcastRecord r, ProcessRecord app, IIntentReceiver receiver,</span></span><br><span class="line"><span class="params">        Intent intent, <span class="type">int</span> resultCode, String data, Bundle extras,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">boolean</span> shareIdentity, <span class="type">int</span> sendingUser,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> receiverUid, <span class="type">int</span> callingUid, String callingPackage,</span></span><br><span class="line"><span class="params">        <span class="type">long</span> dispatchDelay, <span class="type">long</span> receiveDelay, <span class="type">int</span> priority,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> receiverProcessState)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Send the intent to the receiver asynchronously using one-way binder calls.</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="literal">null</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">IApplicationThread</span> <span class="variable">thread</span> <span class="operator">=</span> app.getThread();</span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="literal">null</span>) &#123;  <span class="comment">// 2</span></span><br><span class="line">            <span class="comment">// If we have an app thread, do the call through that so it is</span></span><br><span class="line">            <span class="comment">// correctly ordered with other one-way calls.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">assumeDelivered</span> <span class="operator">=</span> !ordered;</span><br><span class="line">                thread.scheduleRegisteredReceiver(</span><br><span class="line">                        receiver, intent, resultCode,</span><br><span class="line">                        data, extras, ordered, sticky, assumeDelivered, sendingUser,</span><br><span class="line">                        app.mState.getReportedProcState(),</span><br><span class="line">                        shareIdentity ? callingUid : Process.INVALID_UID,</span><br><span class="line">                        shareIdentity ? callingPackage : <span class="literal">null</span>);  <span class="comment">// 3</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1和注释2处的代码表示如果广播接收者所在的应用程序进程存在并且正在运行，则执行注释3处的代码，表示用广播接收者所在的应用程序进程来接收广播，这里thread指的是ApplicationThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread$ApplicationThread</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ApplicationThread</span> <span class="keyword">extends</span> <span class="title class_">IApplicationThread</span>.Stub &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleRegisteredReceiver</span><span class="params">(IIntentReceiver receiver, Intent intent,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> resultCode, String dataStr, Bundle extras, <span class="type">boolean</span> ordered,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> sticky, <span class="type">boolean</span> assumeDelivered, <span class="type">int</span> sendingUser, <span class="type">int</span> processState,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> sendingUid, String sendingPackage)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (receiver <span class="keyword">instanceof</span> LoadedApk.ReceiverDispatcher.InnerReceiver) &#123;</span><br><span class="line">            ((LoadedApk.ReceiverDispatcher.InnerReceiver) receiver).performReceive(intent,</span><br><span class="line">                    resultCode, dataStr, extras, ordered, sticky, assumeDelivered, sendingUser,</span><br><span class="line">                    sendingUid, sendingPackage);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            receiver.performReceive(intent, resultCode, dataStr, extras, ordered, sticky,</span><br><span class="line">                    sendingUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了IIntentReceiver类型的对象receiver的performReceive()方法。IIntentReceiver用于广播的跨进程通信。调用LoadedApk.ReceiverDispatcher.InnerReceiver的performReceive()继续发送广播。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/LoadedApk$ReceiverDispatcher.InnerReceiver</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ReceiverDispatcher</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InnerReceiver</span> <span class="keyword">extends</span> <span class="title class_">IIntentReceiver</span>.Stub &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performReceive</span><span class="params">(Intent intent, <span class="type">int</span> resultCode, String data,</span></span><br><span class="line"><span class="params">                Bundle extras, <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">boolean</span> assumeDelivered,</span></span><br><span class="line"><span class="params">                <span class="type">int</span> sendingUser, <span class="type">int</span> sendingUid, String sendingPackage)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> LoadedApk.ReceiverDispatcher rd;</span><br><span class="line">            <span class="keyword">if</span> (intent == <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                rd = mDispatcher.get();</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (rd != <span class="literal">null</span>) &#123;</span><br><span class="line">                rd.performReceive(intent, resultCode, data, extras,</span><br><span class="line">                        ordered, sticky, assumeDelivered, sendingUser,</span><br><span class="line">                        sendingUid, sendingPackage);  <span class="comment">// 1</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!assumeDelivered) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IIntentReceiver和IActivityManager一样，都使用了AIDL来实现进程间通信。InnerReceiver继承自IIntentReceiver.Stub，是Binder通信的服务器端，IIntentReceiver则是Binder通信的客户端、InnerReceiver在本地的代理，它的具体实现就是InnerReceiver。</p>
<p>注释1处调用了ReceiverDispatcher类型的rd对象的performReceive()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/LoadedApk$ReceiverDispatcher</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ReceiverDispatcher</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performReceive</span><span class="params">(Intent intent, <span class="type">int</span> resultCode, String data,</span></span><br><span class="line"><span class="params">            Bundle extras, <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">boolean</span> assumeDelivered,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> sendingUser, <span class="type">int</span> sendingUid, String sendingPackage)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Args</span> <span class="variable">args</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Args</span>(intent, resultCode, data, extras, ordered,</span><br><span class="line">                sticky, assumeDelivered, sendingUser, sendingUid, sendingPackage);  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (intent == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.wtf(TAG, <span class="string">&quot;Null intent received&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">seq</span> <span class="operator">=</span> intent.getIntExtra(<span class="string">&quot;seq&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">                Slog.i(ActivityThread.TAG, <span class="string">&quot;Enqueueing broadcast &quot;</span> + intent.getAction()</span><br><span class="line">                        + <span class="string">&quot; seq=&quot;</span> + seq + <span class="string">&quot; to &quot;</span> + mReceiver);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (intent == <span class="literal">null</span> || !mActivityThread.post(args.getRunnable())) &#123;  <span class="comment">// 2</span></span><br><span class="line">            <span class="type">IActivityManager</span> <span class="variable">mgr</span> <span class="operator">=</span> ActivityManager.getService();</span><br><span class="line">            <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) Slog.i(ActivityThread.TAG,</span><br><span class="line">                    <span class="string">&quot;Finishing sync broadcast to &quot;</span> + mReceiver);</span><br><span class="line">            args.sendFinished(mgr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处将广播的intent等信息封装为Args对象，注释2处调用mActivityThread的post()方法并传入了Args对象。这个mActivityThread是一个Handler对象，具体指向的就是H，注释2处的代码就是将Args对象的getRunnable()方法通过H发送到线程的消息队列中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/LoadedApk$ReceiverDispatcher.Args</span><br><span class="line">static final class ReceiverDispatcher &#123;</span><br><span class="line">	final class Args extends BroadcastReceiver.PendingResult &#123;</span><br><span class="line">		public final Runnable getRunnable() &#123;</span><br><span class="line">            return () -&gt; &#123;</span><br><span class="line">                final BroadcastReceiver receiver = mReceiver;</span><br><span class="line">                ...</span><br><span class="line">                try &#123;</span><br><span class="line">                    ClassLoader cl = mReceiver.getClass().getClassLoader();</span><br><span class="line">                    intent.setExtrasClassLoader(cl);</span><br><span class="line">                    // TODO: determine at registration time if caller is</span><br><span class="line">                    // protecting themselves with signature permission</span><br><span class="line">                    intent.prepareToEnterProcess(ActivityThread.isProtectedBroadcast(intent),</span><br><span class="line">                            mContext.getAttributionSource());</span><br><span class="line">                    setExtrasClassLoader(cl);</span><br><span class="line">                    receiver.setPendingResult(this);</span><br><span class="line">                    receiver.onReceive(mContext, intent);  // 1</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处执行了BroadcastReceiver类型的receiver对象的onReceive()方法，这样注册的广播接收者就收到了广播并得到了intent。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E5%B9%BF%E6%92%AD%E7%9A%84%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B/" data-id="cltjvv1bj000r8q2u63724jez" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-消息循环创建过程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.577Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="消息循环创建过程"><a href="#消息循环创建过程" class="headerlink" title="消息循环创建过程"></a><center>消息循环创建过程</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>应用程序进程启动后会创建消息循环。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    Looper.prepareMainLooper();  <span class="comment">// 1</span></span><br><span class="line">	...</span><br><span class="line">    <span class="type">ActivityThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityThread</span>();  <span class="comment">// 2</span></span><br><span class="line">    thread.attach(<span class="literal">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="literal">null</span>) &#123;  <span class="comment">// 3</span></span><br><span class="line">        sMainThreadHandler = thread.getHandler();  <span class="comment">// 4</span></span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    Looper.loop();  <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ActivityThread类用于管理当前应用程序进程的主线程。</p>
<p>注释1处创建主线程的消息循环Looper；</p>
<p>注释2处创建ActivityThread；</p>
<p>注释3处判断Handler类型的sMainThreadHandler是否为null，如果为null，则在注释4处获取H类并赋值给sMainThreadHandler，这个H类继承自Handler，是ActivityThread的内部类，用于处理主线程的消息循环；</p>
<p>注释5处调用Looper#loop()，使得Looper开始处理消息。</p>
<p>可以看出，系统在应用程序进程启动完成后，就会创建一个消息循环，这样运行在应用程序进程中的应用程序可以方便地使用消息处理机制。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" data-id="cltjvv1bl000v8q2ud9w7bztc" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-软重启功能调研" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E8%BD%AF%E9%87%8D%E5%90%AF%E5%8A%9F%E8%83%BD%E8%B0%83%E7%A0%94/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.576Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="软重启作用"><a href="#软重启作用" class="headerlink" title="软重启作用"></a>软重启作用</h4><p>软重启即用户空间中进程的运行时重启。</p>
<ol>
<li>用于应用需要重启的更新（例如，对APEX包的更新），会重启用户空间。</li>
<li>可以清除临时错误，而无需删除任何数据或设置。如，冻结、性能缓慢和其他软件相关问题。</li>
</ol>
<h4 id="启用软重启功能"><a href="#启用软重启功能" class="headerlink" title="启用软重启功能"></a>启用软重启功能</h4><p>设置系统属性<code>init.userspace_reboot.is_supported=1</code></p>
<h4 id="判断系统是否支持软重启"><a href="#判断系统是否支持软重启" class="headerlink" title="判断系统是否支持软重启"></a>判断系统是否支持软重启</h4><ol>
<li><p><code>adb shell getprop | grep init.userspace_reboot.is_supported</code>判断系统属性值；</p>
</li>
<li><p>调用API：<code>PowerManager.isRebootingUserspace()</code>，最终也是判断系统属性值。</p>
</li>
</ol>
<h4 id="请求软重启"><a href="#请求软重启" class="headerlink" title="请求软重启"></a>请求软重启</h4><ol>
<li><p>调用<code>PowerManager.reboot(PowerManager.REBOOT_USERSPACE)</code></p>
</li>
<li><p><code>adb shell svc power reboot userspace</code></p>
</li>
<li><p><code>adb reboot userspace</code></p>
</li>
</ol>
<h4 id="判断软重启是否成功"><a href="#判断软重启是否成功" class="headerlink" title="判断软重启是否成功"></a>判断软重启是否成功</h4><p>软重启失败会回退到硬重启。硬重启成功会亮屏且听到一声通知提示音；软重启成功仅听到一声通知提示音，不会自动亮屏。</p>
<h4 id="重启时长"><a href="#重启时长" class="headerlink" title="重启时长"></a>重启时长</h4><p>以输入命令按下Enter或点击“重新启动”作为开始，以听到通知提示音为结束，计算时长。</p>
<p>该数据在M2381设备测得，仅作参考。</p>
<ol>
<li><code>adb shell svc power reboot userspace</code>，软重启，约13秒；</li>
<li><code>adb reboot userspace</code>，软重启，约20秒；</li>
<li>长按电源键，点击“重新启动”，硬重启，约22秒。</li>
</ol>
<h4 id="软重启流程"><a href="#软重启流程" class="headerlink" title="软重启流程"></a>软重启流程</h4><p>以<code>adb shell svc power reboot userspace</code>为例。</p>
<ul>
<li><p><code>init.cpp#SecondStageMain</code>中的死循环监听关机命令 -&gt;</p>
</li>
<li><p><code>reboot.cpp#HandlePowerctlMessage()</code> -&gt; </p>
</li>
<li><p><code>reboot.cpp#HandleUserspaceReboot()</code></p>
<ol>
<li><p>根据<code>init.userspace_reboot.is_supported</code>判断系统是否支持软重启</p>
</li>
<li><p>触发<code>userspace-reboot-requested</code>事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">on userspace-reboot-requested</span><br><span class="line">  setprop sys.boot_completed &quot;&quot;</span><br><span class="line">  setprop dev.bootcomplete &quot;&quot;</span><br><span class="line">  setprop sys.init.updatable_crashing &quot;&quot;</span><br><span class="line">  setprop sys.init.updatable_crashing_process_name &quot;&quot;</span><br><span class="line">  setprop sys.user.0.ce_available &quot;&quot;</span><br><span class="line">  setprop sys.shutdown.requested &quot;&quot;</span><br><span class="line">  setprop service.bootanim.exit &quot;&quot;</span><br><span class="line">  setprop service.bootanim.progress &quot;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>reboot.cpp#DoUserspaceReboot()</code></p>
<p>设置属性<code>sys.init.userspace_reboot.in_progress</code>为true，设置失败则软重启失败；</p>
<p>重置属性<code>sys.powerctl</code>为””，重置失败则软重启失败；</p>
<p>记录enabled状态的服务，重启时需要手动enable；</p>
<p>终止上一步记录的服务，超时则软重启失败；</p>
<p>卸载zram支持设备，卸载失败则软重启失败；</p>
<p>执行<code>/system/bin/vdc volume reset</code>命令，执行失败则软重启失败；</p>
<p>卸载apex包，否则它们可能阻止&#x2F;data的彻底卸载，卸载失败则软重启失败；</p>
<p>切换到bootstrap命名空间，切换失败则软重启失败；</p>
<p>移除apex中定义的服务；</p>
<p>重新enable服务；</p>
<p>触发<code>userspace-reboot-resume</code>(见备注1)</p>
</li>
</ol>
</li>
</ul>
<p>备注1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">on userspace-reboot-resume</span><br><span class="line">    # 启动vold进程，卸载/data镜像目录，播放动画</span><br><span class="line">    # 见备注2</span><br><span class="line">    trigger userspace-reboot-fs-remount</span><br><span class="line"></span><br><span class="line">    # 挂载/data，创建/data下的目录，启动bootchart、tombstoned、apexd、logd、logd-reinit、odsign</span><br><span class="line">    # 执行derive_sdk、derive_classpath、apexd-snapshotde</span><br><span class="line">    # 见备注3</span><br><span class="line">    trigger post-fs-data</span><br><span class="line"></span><br><span class="line">    # 执行update_verifier_nonencrypted，启动statsd、netd、zygote、zygote_secondary</span><br><span class="line">    # 见备注4</span><br><span class="line">    trigger zygote-start</span><br><span class="line"></span><br><span class="line">    # 见备注5</span><br><span class="line">    trigger early-boot</span><br><span class="line"></span><br><span class="line">    # 对网络、内存管理、文件系统进行设置，启动class为hal和core的服务</span><br><span class="line">    # 见备注6</span><br><span class="line">    trigger boot</span><br></pre></td></tr></table></figure>

<p>备注2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">on userspace-reboot-fs-remount</span><br><span class="line">    # vold是一个守护进程，用来管理Android中存储类的热插拔事件，其中包括设备开关机过程中存储设备各分区的挂卸载</span><br><span class="line">    # 预防重启过程中，vold因为一些原因没有正常运行</span><br><span class="line">    start vold</span><br><span class="line">    exec - system system -- /system/bin/vdc checkpoint resetCheckpoint</span><br><span class="line">    exec - system system -- /system/bin/vdc checkpoint markBootAttempt</span><br><span class="line">    # 卸载/data镜像目录</span><br><span class="line">    umount /data_mirror/data_ce/null/0</span><br><span class="line">    umount /data_mirror/data_ce/null</span><br><span class="line">    umount /data_mirror/data_de/null</span><br><span class="line">    umount /data_mirror/cur_profiles</span><br><span class="line">    umount /data_mirror/ref_profiles</span><br><span class="line">    umount /data_mirror</span><br><span class="line">    remount_userdata</span><br><span class="line">    # 播放动画</span><br><span class="line">    start bootanim</span><br></pre></td></tr></table></figure>

<p>备注3：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">on post-fs-data</span><br><span class="line"></span><br><span class="line">    mark_post_data</span><br><span class="line"></span><br><span class="line">    # Start checkpoint before we touch data</span><br><span class="line">    exec - system system -- /system/bin/vdc checkpoint prepareCheckpoint</span><br><span class="line"></span><br><span class="line">    # We chown/chmod /data again so because mount is run as root + defaults</span><br><span class="line">    chown system system /data</span><br><span class="line">    chmod 0771 /data</span><br><span class="line">    # 恢复/data的安全上下文</span><br><span class="line">    restorecon /data</span><br><span class="line"></span><br><span class="line">    # 创建DE密钥</span><br><span class="line">    installkey /data</span><br><span class="line"></span><br><span class="line">    # 启动bootchart，bootchart是系统启动过程性能分析的工具</span><br><span class="line">    mkdir /data/bootchart 0755 shell shell encryption=Require</span><br><span class="line">    bootchart start</span><br><span class="line"></span><br><span class="line">    # /dev/urandom是随机数设备。避免可预测的熵池，继承上次启动的熵</span><br><span class="line">    copy /data/system/entropy.dat /dev/urandom</span><br><span class="line"></span><br><span class="line">    mkdir /data/vendor 0771 root root encryption=Require</span><br><span class="line">    mkdir /data/vendor_ce 0771 root root encryption=None</span><br><span class="line">    mkdir /data/vendor_de 0771 root root encryption=None</span><br><span class="line">    mkdir /data/vendor/hardware 0771 root root</span><br><span class="line"></span><br><span class="line">    # 启动tombstoned</span><br><span class="line">    mkdir /data/anr 0775 system system encryption=Require</span><br><span class="line">    mkdir /data/tombstones 0771 system system encryption=Require</span><br><span class="line">    mkdir /data/vendor/tombstones 0771 root root</span><br><span class="line">    mkdir /data/vendor/tombstones/wifi 0771 wifi wifi</span><br><span class="line">    start tombstoned</span><br><span class="line"></span><br><span class="line">    # 设置默认的mount namespace</span><br><span class="line">    enter_default_mount_ns</span><br><span class="line"></span><br><span class="line">    # 创建密钥库目录结构，为启动apexd做准备</span><br><span class="line">    mkdir /data/misc 01771 system misc encryption=Require</span><br><span class="line">    mkdir /data/misc/keystore 0700 keystore keystore</span><br><span class="line">    # work around b/183668221</span><br><span class="line">    restorecon /data/misc /data/misc/keystore</span><br><span class="line"></span><br><span class="line">    # 设置odsign签名密钥的启动级别为MAX_BOOT_LEVEL=30</span><br><span class="line">    setprop keystore.boot_level 30</span><br><span class="line"></span><br><span class="line">    # 现在/data已挂载并且我们已经创建了/data/misc/keystore</span><br><span class="line">    # 可以通知keystore停止允许使用early-boot密钥</span><br><span class="line">    # 并首次访问其数据库以支持MAX_BOOT_LEVEL密钥的创建和使用。</span><br><span class="line">    exec - system system -- /system/bin/vdc keymaster earlyBootEnded</span><br><span class="line"></span><br><span class="line">    # 在启动apexd前加载持久属性</span><br><span class="line">    load_persist_props</span><br><span class="line">    start logd</span><br><span class="line">    start logd-reinit</span><br><span class="line">   </span><br><span class="line">    trigger load_persist_props_action</span><br><span class="line"></span><br><span class="line">    # 启动apexd，激活APEXes.</span><br><span class="line">    mkdir /data/apex 0755 root system encryption=None</span><br><span class="line">    mkdir /data/apex/active 0755 root system</span><br><span class="line">    mkdir /data/apex/backup 0700 root system</span><br><span class="line">    mkdir /data/apex/decompressed 0755 root system encryption=Require</span><br><span class="line">    mkdir /data/apex/hashtree 0700 root system</span><br><span class="line">    mkdir /data/apex/sessions 0700 root system</span><br><span class="line">    mkdir /data/app-staging 0751 system system encryption=DeleteIfNecessary</span><br><span class="line">    mkdir /data/apex/ota_reserved 0700 root system encryption=Require</span><br><span class="line">    setprop apexd.status &quot;&quot;</span><br><span class="line">    restart apexd</span><br><span class="line"></span><br><span class="line">    # 创建/data下剩余的目录</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    exec_start derive_sdk</span><br><span class="line"></span><br><span class="line">	# 创建CE密钥</span><br><span class="line">    init_user0</span><br><span class="line"></span><br><span class="line">    # 在升级或策略更新时设置 SELinux 安全上下文。</span><br><span class="line">    restorecon --recursive --skip-ce /data</span><br><span class="line"></span><br><span class="line">    # 定义并导出*CLASSPATH变量。odsign依赖*CLASSPATH变量</span><br><span class="line">    exec_start derive_classpath</span><br><span class="line">    load_exports /data/system/environ/classpath</span><br><span class="line"></span><br><span class="line">    # on-device signing守护程序，在需要时生成ART工件</span><br><span class="line">    start odsign</span><br><span class="line"></span><br><span class="line">    # 等待odsign使用完密钥</span><br><span class="line">    wait_for_prop odsign.key.done 1</span><br><span class="line"></span><br><span class="line">    # fs-verity用于文件身份验证，锁定fs-verity密钥环，使无法添加更多密钥</span><br><span class="line">    exec -- /system/bin/fsverity_init --lock</span><br><span class="line"></span><br><span class="line">    # 将启动级别提升至1000000000；这会阻止进一步的on-device签名，用于关闭侦听进一步更新的线程。</span><br><span class="line">    setprop keystore.boot_level 1000000000</span><br><span class="line"></span><br><span class="line">    # 允许apexd在回滚时快照并恢复设备加密的apex数据。这应该在加载DE_user数据密钥后立即完成。在完成此操作并且 apexd.status变为“就绪”之前，APEX不应访问此数据。</span><br><span class="line">    exec_start apexd-snapshotde</span><br><span class="line"></span><br><span class="line">    # 检查/data中的时区数据是否比时区数据模块中的副本新，如果不是则删除</span><br><span class="line">    exec - system system -- /system/bin/tzdatacheck /apex/com.android.tzdata/etc/tz /data/misc/zoneinfo</span><br><span class="line"></span><br><span class="line">    # sys.memfd_use默认设置为false，这会使其保持禁用状态，直到确认应用程序和供应商进程不再对ashmem fds进行 IOCTL</span><br><span class="line">    setprop sys.use_memfd false</span><br><span class="line"></span><br><span class="line">    chown root system /dev/fscklogs/log</span><br><span class="line">    chmod 0770 /dev/fscklogs/log</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p><code>on post-fs-data</code>中触发了<code>load_persist_props_action</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$/system/logging/logcat/logcatd.rc</span><br><span class="line">on load_persist_props_action</span><br><span class="line">    setprop logd.logpersistd.enable true</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$/system/server_configurable_flags/disaster_recovery/flags_health_check.rc</span><br><span class="line">on load_persist_props_action</span><br><span class="line">    # check server configurable flags(which is based on persistent properties) related</span><br><span class="line">    # disaster recovery</span><br><span class="line">    mkdir /data/server_configurable_flags 0775 system system encryption=Require</span><br><span class="line">    exec - system system -- /system/bin/flags_health_check BOOT_FAILURE</span><br></pre></td></tr></table></figure>

<p>备注4：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=...</span><br><span class="line">    wait_for_prop odsign.verification.done 1</span><br><span class="line">    # A/B update verifier that marks a successful boot.</span><br><span class="line">    exec_start update_verifier_nonencrypted</span><br><span class="line">    start statsd</span><br><span class="line">    start netd</span><br><span class="line">    start zygote</span><br><span class="line">    start zygote_secondary</span><br></pre></td></tr></table></figure>

<p>备注5：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$/frameworks/native/cmds/installd/installd.rc</span><br><span class="line">on early-boot</span><br><span class="line">    mkdir /config/sdcardfs/extensions/1055</span><br><span class="line">    mkdir /config/sdcardfs/extensions/1056</span><br><span class="line">    mkdir /config/sdcardfs/extensions/1057</span><br><span class="line">    ...</span><br><span class="line">    # 在1055、1056、1057文件夹下又创建了一些文件夹</span><br></pre></td></tr></table></figure>

<p>&#x2F;device&#x2F;linaro&#x2F;dragonboard&#x2F;init.common.rc中也监听了early-boot，但是没有触发。</p>
<p>备注6：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">on boot</span><br><span class="line">    # 初始化网络</span><br><span class="line">    # 启用lo回环网卡</span><br><span class="line">    ifup lo</span><br><span class="line">    hostname localhost</span><br><span class="line">    domainname localdomain</span><br><span class="line"></span><br><span class="line">    # IPsec SA默认expiration长度</span><br><span class="line">    write /proc/sys/net/core/xfrm_acq_expires 3600</span><br><span class="line"></span><br><span class="line">    # 设置内存管理的参数</span><br><span class="line">    write /proc/sys/vm/overcommit_memory 1</span><br><span class="line">    write /proc/sys/vm/min_free_order_shift 4</span><br><span class="line"></span><br><span class="line">    # System server管理zram writeback</span><br><span class="line">    # writeback功能，可以将zram中申请的物理页回写到真实的磁盘中，进一步释放内存</span><br><span class="line">    chown root system /sys/block/zram0/idle</span><br><span class="line">    chmod 0664 /sys/block/zram0/idle</span><br><span class="line">    chown root system /sys/block/zram0/writeback</span><br><span class="line">    chmod 0664 /sys/block/zram0/writeback</span><br><span class="line"></span><br><span class="line">    # to access F2FS sysfs on dm-&lt;num&gt; directly</span><br><span class="line">    mkdir /dev/sys/fs/by-name 0755 system system</span><br><span class="line">    symlink /sys/fs/f2fs/$&#123;dev.mnt.dev.data&#125; /dev/sys/fs/by-name/userdata</span><br><span class="line"></span><br><span class="line">    # dev.mnt.dev.data=dm-N, dev.mnt.blk.data=sdaN/mmcblk0pN, dev.mnt.rootdisk.data=sda/mmcblk0, or</span><br><span class="line">    # dev.mnt.dev.data=sdaN/mmcblk0pN, dev.mnt.blk.data=sdaN/mmcblk0pN, dev.mnt.rootdisk.data=sda/mmcblk0</span><br><span class="line">    mkdir /dev/sys/block/by-name 0755 system system</span><br><span class="line">    symlink /sys/class/block/$&#123;dev.mnt.dev.data&#125; /dev/sys/block/by-name/userdata</span><br><span class="line">    symlink /sys/class/block/$&#123;dev.mnt.rootdisk.data&#125; /dev/sys/block/by-name/rootdisk</span><br><span class="line"></span><br><span class="line">    # F2FS tuning. Set cp_interval larger than dirty_expire_centisecs, 30 secs,</span><br><span class="line">    # to avoid power consumption when system becomes mostly idle. Be careful</span><br><span class="line">    # to make it too large, since it may bring userdata loss, if they</span><br><span class="line">    # are not aware of using fsync()/sync() to prepare sudden power-cut.</span><br><span class="line">    write /dev/sys/fs/by-name/userdata/cp_interval 200</span><br><span class="line">    write /dev/sys/fs/by-name/userdata/gc_urgent_sleep_time 50</span><br><span class="line">    write /dev/sys/fs/by-name/userdata/iostat_enable 1</span><br><span class="line"></span><br><span class="line">    # 为POSIX_FADV_SEQUENTIAL文件设置预读乘数readahead multiplier</span><br><span class="line">    # 预读乘数会影响读性能，它控制在一个读请求之后，有多少连续数据块被保存到缓存里</span><br><span class="line">    write /dev/sys/fs/by-name/userdata/seq_file_ra_mul 16</span><br><span class="line"></span><br><span class="line">    # 将丢弃大小限制为128MB，以避免调整文件系统（dm或sda）时出现较长的IO延迟。</span><br><span class="line">    # 这需要在供应商端启用sda/mmcblk0 的selinux 条目</span><br><span class="line">    write /dev/sys/block/by-name/userdata/queue/discard_max_bytes 134217728</span><br><span class="line">    write /dev/sys/block/by-name/rootdisk/queue/discard_max_bytes 134217728</span><br><span class="line"></span><br><span class="line">    # 设置System Server和daemons.</span><br><span class="line">    chown system system /sys/power/autosleep</span><br><span class="line"></span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/timer_rate</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/timer_rate</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/timer_slack</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/timer_slack</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/min_sample_time</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/min_sample_time</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/target_loads</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/target_loads</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/boost</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/boost</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/boostpulse</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/input_boost</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/input_boost</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/boostpulse_duration</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/boostpulse_duration</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpufreq/interactive/io_is_busy</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/io_is_busy</span><br><span class="line"></span><br><span class="line">    # 假设SMP对所有CPU使用共享cpufreq策略</span><br><span class="line">    chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq</span><br><span class="line">    chmod 0660 /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq</span><br><span class="line"></span><br><span class="line">    chown system system /sys/class/leds/vibrator/trigger</span><br><span class="line">    chown system system /sys/class/leds/vibrator/activate</span><br><span class="line">    chown system system /sys/class/leds/vibrator/brightness</span><br><span class="line">    chown system system /sys/class/leds/vibrator/duration</span><br><span class="line">    chown system system /sys/class/leds/vibrator/state</span><br><span class="line">    chown system system /sys/class/timed_output/vibrator/enable</span><br><span class="line">    chown system system /sys/class/leds/keyboard-backlight/brightness</span><br><span class="line">    chown system system /sys/class/leds/lcd-backlight/brightness</span><br><span class="line">    chown system system /sys/class/leds/button-backlight/brightness</span><br><span class="line">    chown system system /sys/class/leds/jogball-backlight/brightness</span><br><span class="line">    chown system system /sys/class/leds/red/brightness</span><br><span class="line">    chown system system /sys/class/leds/green/brightness</span><br><span class="line">    chown system system /sys/class/leds/blue/brightness</span><br><span class="line">    chown system system /sys/class/leds/red/device/grpfreq</span><br><span class="line">    chown system system /sys/class/leds/red/device/grppwm</span><br><span class="line">    chown system system /sys/class/leds/red/device/blink</span><br><span class="line">    chown system system /sys/module/sco/parameters/disable_esco</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_wmem_min</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_wmem_def</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_wmem_max</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_rmem_min</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_rmem_def</span><br><span class="line">    chown system system /sys/kernel/ipv4/tcp_rmem_max</span><br><span class="line">    chown root radio /proc/cmdline</span><br><span class="line"></span><br><span class="line">    # 以段为单位定义默认初始接收窗口大小。</span><br><span class="line">    setprop net.tcp_def_init_rwnd 60</span><br><span class="line"></span><br><span class="line">    #FLYME|dzh@meizu.com|lmk-opt: disable rescue party temporarily</span><br><span class="line">    setprop persist.sys.disable_rescue true</span><br><span class="line"></span><br><span class="line">    # 更新dm-verity状态并设置partition.*.verified属性</span><br><span class="line">    verity_update_state</span><br><span class="line"></span><br><span class="line">    # 启动class为hal的服务</span><br><span class="line">    class_start hal</span><br><span class="line"></span><br><span class="line">    # 启动class为core的服务</span><br><span class="line">    class_start core</span><br></pre></td></tr></table></figure>

<p>class为hal的服务有：healthd、hidl_memory、vendor.contexthub-default、confirmationui-1-0、vendor.gatekeeper-1-0。</p>
<p>class为core的服务有：artd、audioserver、bootanim、shutdownanim、servicemanager、vndservicemanager、gpu、surfaceflinger、bufferhubd、performanced、virtual_touchpad、ueventd、console、adbd、apexd、lmkd、credstore、odsign、vold等。<br>车辆服务：carbugreportd、cartelemetryd_service、carwatchdogd、com.android.car.procfsinspector。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E8%BD%AF%E9%87%8D%E5%90%AF%E5%8A%9F%E8%83%BD%E8%B0%83%E7%A0%94/" data-id="cltjvv1bk000u8q2u30bggdaq" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-上下文Context" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E4%B8%8A%E4%B8%8B%E6%96%87Context/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.575Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="上下文Context"><a href="#上下文Context" class="headerlink" title="上下文Context"></a><center>上下文Context</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>Context意为上下文，是一个应用程序环境信息的接口。它的使用场景总的来说分为两大类，分别是：</p>
<ul>
<li>使用Context调用方法，比如启动Activity、访问资源、调用系统服务等。</li>
<li>调用方法时传入Context，比如弹出Toast、创建Dialog等。</li>
</ul>
<p>Activity、Service和Application都间接地继承自Context，因此我们可以计算出一个应用程序进程中有多少个Context，这个数量等于Activity和Service的总个数加1，1指的是Application的数量。</p>
<p>Context是一个抽象类，它的内部定义了很多方法以及静态变量，它的具体实现类为ContextImpl。和Context相关联的类，除了ContextImpl，还有ContextWrapper、ContextThemeWrapper和Activity等。</p>
<img src="https://s2.loli.net/2024/01/03/Gubp61ZmkDIcVdY.jpg" style="zoom:50%;" />

<p>ContextImpl和ContextWrapper继承自Context，ContextWrapper内部包含Context类型的mBase对象，mBase具体指向ContextImpl。ContextImpl提供了很多功能，但是外界需要使用并拓展ContextImpl的功能，因此设计上使用了装饰模式，ContextWrapper是装饰类，它对ContextImpl进行包装，ContextWrapper主要是起了方法传递的作用，ContextWrapper中几乎所有的方法都是调用ContextImpl的相应方法来实现的。ContextThemeWrapper、Service和Application都继承自ContextWrapper，这样它们都可以通过mBase来使用Context的方法，同时它们也是装饰类，在ContextWrapper的基础上又添加了不同的功能。ContextThemeWrapper中包含和主题相关的方法（比如getTheme方法），因此需要主题的Activity继承ContextThemeWrapper，而不需要主题的Service继承ContextWrapper。</p>
<p>Context的关联类采用了装饰模式，主要有以下的优点：</p>
<ul>
<li>使用者（比如Service）能够更方便地使用Context。</li>
<li>如果ContextImpl发生了变化，它的装饰者ContextWrapper不需要做任何修改。</li>
<li>ContextImpl的实现不会暴露给使用者，使用者也不必关心ContextImpl的实现。</li>
<li>通过组合而非继承的方式，拓展ContextImpl的功能，在运行时选择不同的装饰者，实现不同的功能。</li>
</ul>
<h4 id="Application-Context的创建过程"><a href="#Application-Context的创建过程" class="headerlink" title="Application Context的创建过程"></a>Application Context的创建过程</h4><p><img src="https://s2.loli.net/2024/01/03/78Io3ZtzYm5AdlF.jpg"></p>
<p>我们通过调用getApplicationContext来获取应用程序全局的Application Context，那么Application Context是如何创建的呢？在一个应用程序启动完成后，应用程序就会有一个全局的Application Context，那么我们就从应用程序启动过程开始着手。</p>
<p>从ActivityThread的performLaunchActivity()方法开始（前面的调用部分可以看《根Activity的启动过程》）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r);</span><br><span class="line">   <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> appContext.getClassLoader();</span><br><span class="line">       activity = mInstrumentation.newActivity(</span><br><span class="line">               cl, component.getClassName(), r.intent);  <span class="comment">// 1</span></span><br><span class="line">       StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">       r.intent.setExtrasClassLoader(cl);</span><br><span class="line">       r.intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),</span><br><span class="line">               appContext.getAttributionSource());</span><br><span class="line">       <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">           r.state.setClassLoader(cl);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplicationInner(<span class="literal">false</span>, mInstrumentation);  <span class="comment">// 2</span></span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">           ...</span><br><span class="line">           activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                   r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                   r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                   r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                   r.assistToken, r.shareableActivityToken);  <span class="comment">// 3</span></span><br><span class="line">           ...</span><br><span class="line">           <span class="comment">// 4</span></span><br><span class="line">           <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建Activity实例，这里的Activity指的是我们要启动的新的XXXActivity。调用了Instrumentation类的newActivity()方法；</p>
<p>注释2处尝试<strong>创建Application</strong>，r.packageInfo返回的是LoadedApk对象，调用了LoadedApk的makeApplicationInner()方法。</p>
<p>注释3处创建Activity的PhoneWindow，并将当前线程设置成主线程。我们在这个fork出来的新进程中还没有创建其他线程，这个Activity也是该App启动的第一个Activity，所以这个Activity就是在主线程中运行的。</p>
<p>注释4处调用了Instrumentation的callActivityOnCreate()，执行新Activity的onCreate生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="line"><span class="keyword">public</span> Application <span class="title function_">makeApplicationInner</span><span class="params">(<span class="type">boolean</span> forceDefaultAppClass,</span></span><br><span class="line"><span class="params">        Instrumentation instrumentation)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> makeApplicationInner(forceDefaultAppClass, instrumentation,</span><br><span class="line">            <span class="comment">/* allowDuplicateInstances= */</span> <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Application <span class="title function_">makeApplicationInner</span><span class="params">(<span class="type">boolean</span> forceDefaultAppClass,</span></span><br><span class="line"><span class="params">        Instrumentation instrumentation, <span class="type">boolean</span> allowDuplicateInstances)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="literal">null</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> ContextImpl.createAppContext(mActivityThread, <span class="built_in">this</span>);  <span class="comment">// 2</span></span><br><span class="line">        <span class="comment">// The network security config needs to be aware of multiple</span></span><br><span class="line">        <span class="comment">// applications in the same process to handle discrepancies</span></span><br><span class="line">        NetworkSecurityConfigProvider.handleNewApplication(appContext);</span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext);  <span class="comment">// 3</span></span><br><span class="line">        appContext.setOuterContext(app);  <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;  <span class="comment">// 5</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处如果mApplication不为null则返回mApplication，这里假设是第一次启动应用程序，因此mApplication为null。</p>
<p>注释2处通过ContextImpl的createAppContext()方法来创建ContextImpl。</p>
<p>注释3处<strong>创建Application</strong>，在Instrumentation的newApplication()方法中传入了ClassLoader类型的对象以及注释2处创建的ContextImpl。</p>
<p>注释4处将Application赋值给ContextImpl的Context类型的成员变量mOuterContext，这样ContextImpl中也包含了Application的引用。</p>
<p>注释5处将Application赋值给LoadedApk的成员变量mApplication，这个mApplication是Application类型的对象，它用来代表Application Context。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="keyword">public</span> Application <span class="title function_">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span><br><span class="line">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span><br><span class="line">        ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> getFactory(context.getPackageName())</span><br><span class="line">            .instantiateApplication(cl, className);  <span class="comment">// 1</span></span><br><span class="line">    app.attach(context);  <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处通过反射来创建Application，注释2处调用了Application的attach()方法，将ContextImpl传进去，最后返回该Application。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Application.java</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用attachBaseContext()，它在Application的父类ContextWrapper中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context base)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Base context already set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个base一路传递过来指的是ContextImpl，它是Context的实现类，将ContextImpl赋值给ContextWrapper的Context类型的成员变量mBase，这样在ContextWrapper中就可以使用Context的方法，而Application继承自ContextWrapper，同样可以使用Context的方法。Application的attach()方法的作用就是使Application可以使用Context的方法，这样Application才可以用来代表Application Context。</p>
<h4 id="Application-Context的获取过程"><a href="#Application-Context的获取过程" class="headerlink" title="Application Context的获取过程"></a>Application Context的获取过程</h4><p>我们通过调用getApplicationContext()方法来获得Application Context，getApplicationContext()方法在ContextWrapper中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">getApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mBase.getApplicationContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mBase指的是ContextImpl。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="line"><span class="keyword">public</span> Context <span class="title function_">getApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (mPackageInfo != <span class="literal">null</span>) ?</span><br><span class="line">            mPackageInfo.getApplication() : mMainThread.getApplication();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果LoadedApk类型的mPackageInfo不为null，则调用LoadedApk的getApplication()方法，否则调用ActivityThread的getApplication()方法。由于应用程序这时已经启动，因此LoadedApk不会为null。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/LoadedApk.java</span><br><span class="line">Application <span class="title function_">getApplication</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的mApplication在上文LoadedApk的makeApplication()方法的注释5处被赋值。这样我们通过getApplication()方法就获取到了Application Context。</p>
<h4 id="Activity的Context创建过程"><a href="#Activity的Context创建过程" class="headerlink" title="Activity的Context创建过程"></a>Activity的Context创建过程</h4><p><img src="https://s2.loli.net/2024/01/03/jfPZ8H7DeuUIdB6.jpg"></p>
<p>想要在Activity中使用Context提供的方法，务必要先创建Context。Activity的Context会在Activity的启动过程中被创建。</p>
<p>从ActivityThread的performLaunchActivity()方法开始（前面的调用部分可以看《根Activity的启动过程》）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r);  <span class="comment">// 1</span></span><br><span class="line">   <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> appContext.getClassLoader();</span><br><span class="line">       activity = mInstrumentation.newActivity(</span><br><span class="line">               cl, component.getClassName(), r.intent);  <span class="comment">// 2</span></span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       </span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">           ...</span><br><span class="line">           appContext.setOuterContext(activity);  <span class="comment">// 3</span></span><br><span class="line">           activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                   r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                   r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                   r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                   r.assistToken, r.shareableActivityToken);  <span class="comment">// 4</span></span><br><span class="line">           ...</span><br><span class="line">           <span class="comment">// 5</span></span><br><span class="line">           <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释2处用来创建Activity的实例。</p>
<p>注释1处通过createBaseContextForActivity()方法来创建Activity的ContextImpl，并将ContextImpl传入注释4处的activity的attach()方法中。</p>
<p>注释3处调用了ContextImpl的setOuterContext()方法，将此前创建的Acitivity实例赋值给ContextImpl的成员变量mOuterContext，这样ContextImpl也可以访问Activity的变量和方法。</p>
<p>注释5处mInstrumentation的callActivityOnCreate()方法中会调用Activity的onCreate()方法。</p>
<ol>
<li><p>createBaseContextForActivity()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">private</span> ContextImpl <span class="title function_">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> ContextImpl.createActivityContext(</span><br><span class="line">            <span class="built_in">this</span>, r.packageInfo, r.activityInfo, r.token, displayId, r.overrideConfig);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> appContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在createBaseContextForActivity()中会调用ContextImpl的createActivityContext()方法来创建ContextImpl。</p>
</li>
<li><p>activity.attach()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span><br><span class="line"><span class="params">        Instrumentation instr, IBinder token, <span class="type">int</span> ident,</span></span><br><span class="line"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span><br><span class="line"><span class="params">        CharSequence title, Activity parent, String id,</span></span><br><span class="line"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span><br><span class="line"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">        Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken,</span></span><br><span class="line"><span class="params">        IBinder shareableActivityToken)</span> &#123;</span><br><span class="line">    attachBaseContext(context);  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    mFragments.attachHost(<span class="literal">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line">    mActivityInfo = info;</span><br><span class="line"></span><br><span class="line">    mWindow = <span class="keyword">new</span> <span class="title class_">PhoneWindow</span>(<span class="built_in">this</span>, window, activityConfigCallback);  <span class="comment">// 2</span></span><br><span class="line">    mWindow.setWindowControllerCallback(mWindowControllerCallback);</span><br><span class="line">    mWindow.setCallback(<span class="built_in">this</span>);  <span class="comment">// 3</span></span><br><span class="line">    mWindow.setOnWindowDismissedCallback(<span class="built_in">this</span>);</span><br><span class="line">    mWindow.getLayoutInflater().setPrivateFactory(<span class="built_in">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);  <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="literal">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();  <span class="comment">// 5</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在注释2处创建PhoneWindow，它代表应用程序窗口。PhoneWindow在运行中会间接触发很多事件，比如点击、菜单弹出、屏幕焦点变化等事件，这些事件需要转发给与PhoneWindow关联的Activity，转发操作通过Window.Callback接口实现，Activity实现了这个接口。在注释3处将当前Activity通过Window的setCallback()方法传递给PhoneWindow。在注释4处为PhoneWindow设置WindowManager，在注释5处获取WindowManager并赋值给Activity的成员变量mWindowManager，这样在Activity中就可以通过getWindowManager()方法来获取WindowManager。</p>
<p>注释1处的attachBaseContext()方法在ContextThemeWrapper中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/view/ContextThemeWrapper.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context newBase)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.attachBaseContext(newBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>attachBaseContext()调用ContextThemeWrapper父类ContextWrapper的attachBaseContext()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context base)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Base context already set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;  <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处的base指的是一路传递过来的Activity的ContextImpl，将它赋值给ContextWrapper的成员变量mBase。这样ContextWrapper的功能就可以交由ContextImpl来处理。举个例子，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">public</span> Resources.Theme <span class="title function_">getTheme</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mBase.getTheme();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们调用ContextWrapper的getTheme()方法时，其实就是调用了ContextImpl的getTheme()方法。</p>
<p>总结：在启动Activity的过程中创建ContextImpl，并赋值给ContextWrapper的成员变量mBase。Activity继承自ContextWrapper的子类ContextThemeWrapper，这样在Activity中就可以使用Context中定义的方法了。</p>
</li>
</ol>
<h4 id="Service的Context创建过程"><a href="#Service的Context创建过程" class="headerlink" title="Service的Context创建过程"></a>Service的Context创建过程</h4><p>Service的Context创建过程与Activity的Context创建过程类似，是在Service的启动过程中被创建的。</p>
<p>我们从ActivityThread的handleCreateService()开始分析。</p>
<p>handleMessage()方法根据消息类型为CREATE_SERVICE，会调用handleCreateService()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleCreateService</span><span class="params">(CreateServiceData data)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> ContextImpl.getImpl(service</span><br><span class="line">                .createServiceBaseContext(<span class="built_in">this</span>, packageInfo));  <span class="comment">// 1</span></span><br><span class="line">        ...</span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line">        service.attach(context, <span class="built_in">this</span>, data.info.name, data.token, app,</span><br><span class="line">                ActivityManager.getService());  <span class="comment">// 2</span></span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处通过ContextImpl的createServiceBaseContext()方法创建了ContextImpl，并将该ContextImpl传入注释2处service的attach()方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Service.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(</span></span><br><span class="line"><span class="params">        Context context,</span></span><br><span class="line"><span class="params">        ActivityThread thread, String className, IBinder token,</span></span><br><span class="line"><span class="params">        Application application, Object activityManager)</span> &#123;</span><br><span class="line">    attachBaseContext(context);  <span class="comment">// 1</span></span><br><span class="line">    mThread = thread;           <span class="comment">// <span class="doctag">NOTE:</span>  unused - remove?</span></span><br><span class="line">    mClassName = className;</span><br><span class="line">    mToken = token;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mActivityManager = (IActivityManager)activityManager;</span><br><span class="line">    mStartCompatibility = getApplicationInfo().targetSdkVersion</span><br><span class="line">            &lt; Build.VERSION_CODES.ECLAIR;</span><br><span class="line"></span><br><span class="line">    setContentCaptureOptions(application.getContentCaptureOptions());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处调用了attachBaseContext()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Service.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context newBase)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.attachBaseContext(newBase);  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (newBase != <span class="literal">null</span>) &#123;</span><br><span class="line">        newBase.setContentCaptureOptions(getContentCaptureOptions());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处调用了ContextWrapper的attachBaseContext()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context base)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Base context already set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;  <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处的base指的是一路传递过来的Service的ContextImpl，将它赋值给ContextWrapper的成员变量mBase。这样在ContextWrapper中就可以使用Context的方法，而Service继承自ContextWrapper，同样可以使用Context的方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E4%B8%8A%E4%B8%8B%E6%96%87Context/" data-id="cltjvv1bj000q8q2ufheg179d" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-广播的注册过程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E5%B9%BF%E6%92%AD%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.575Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="广播的动态注册过程"><a href="#广播的动态注册过程" class="headerlink" title="广播的动态注册过程"></a><center>广播的动态注册过程</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>广播的注册通俗来讲就是广播接收者注册自己感兴趣的广播。想要动态注册广播，需要调用registerReceiver方法，它在ContextWrapper中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/content/ContextWrapper.java</span><br><span class="line"><span class="keyword">public</span> Intent <span class="title function_">registerReceiver</span><span class="params">(<span class="meta">@Nullable</span> BroadcastReceiver receiver, IntentFilter filter)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mBase.registerReceiver(receiver, filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mBase具体指向就是ContextImpl，ContextImpl的registerReceiver()方法有很多重载的方法，最终会调用registerReceiverInternal()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="line"><span class="keyword">private</span> Intent <span class="title function_">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        IntentFilter filter, String broadcastPermission,</span></span><br><span class="line"><span class="params">        Handler scheduler, Context context, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="type">IIntentReceiver</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="literal">null</span> &amp;&amp; context != <span class="literal">null</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="literal">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="literal">true</span>);  <span class="comment">// 2</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="literal">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> <span class="title class_">LoadedApk</span>.ReceiverDispatcher(mMainThread.getApplicationThread(),</span><br><span class="line">                    receiver, context, scheduler, <span class="literal">null</span>, <span class="literal">true</span>).getIIntentReceiver();  <span class="comment">// 3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> ActivityManager.getService().registerReceiverWithFeature(</span><br><span class="line">                mMainThread.getApplicationThread(), mBasePackageName, getAttributionTag(),</span><br><span class="line">                AppOpsManager.toReceiverId(receiver), rd, filter, broadcastPermission, userId,</span><br><span class="line">                flags);  <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">            intent.setExtrasClassLoader(getClassLoader());</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> determine at registration time if caller is</span></span><br><span class="line">            <span class="comment">// protecting themselves with signature permission</span></span><br><span class="line">            intent.prepareToEnterProcess(ActivityThread.isProtectedBroadcast(intent),</span><br><span class="line">                    getAttributionSource());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处判断如果LoadedApk类型的mPackageInfo不等于null，并且context不等于null就调用注释2处的代码，通过mPackageInfo的getReceiverDispatcher()方法获取rd对象，否则就调用注释3处的代码来创建rd对象。注释2和注释3处的代码的目的都是要获取IIntentReceiver类型的rd对象，IIntentReceiver是一个Binder接口，用于广播的跨进程的通信，它在LoadedApk.ReceiverDispatcher.InnerReceiver中实现。</p>
<p>注释4处调用了IActivityManager的registerReceiverWithFeature()方法，最终会调用AMS的registerReceiverWithFeature()方法，并将IIntentReceiver类型的rd传进去，这里之所以不直接传入BroadcastReceiver而是传入IIntentReceiver，是因为注册广播是一个跨进程通信过程，需要具有跨进程通信能力的IIntentReceiver。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"><span class="keyword">public</span> Intent <span class="title function_">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage,</span></span><br><span class="line"><span class="params">        IIntentReceiver receiver, IntentFilter filter, String permission, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> registerReceiverWithFeature(caller, callerPackage, <span class="literal">null</span>, <span class="literal">null</span>,</span><br><span class="line">            receiver, filter, permission, userId, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Intent <span class="title function_">registerReceiverWithFeature</span><span class="params">(IApplicationThread caller, String callerPackage,</span></span><br><span class="line"><span class="params">        String callerFeatureId, String receiverId, IIntentReceiver receiver,</span></span><br><span class="line"><span class="params">        IntentFilter filter, String permission, <span class="type">int</span> userId, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    ArrayList&lt;StickyBroadcast&gt; stickyBroadcasts = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ProcessRecord</span> <span class="variable">callerApp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> callingUid;</span><br><span class="line">    <span class="type">int</span> callingPid;</span><br><span class="line">    <span class="type">boolean</span> instantApp;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        callerApp = getRecordForAppLOSP(caller);  <span class="comment">// 1</span></span><br><span class="line">        ...</span><br><span class="line">        Iterator&lt;String&gt; actions = filter.actionsIterator();  <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">if</span> (actions == <span class="literal">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;String&gt; noAction = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">            noAction.add(<span class="literal">null</span>);</span><br><span class="line">            actions = noAction.iterator();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">onlyProtectedBroadcasts</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Collect stickies of users and check if broadcast is only registered for protected</span></span><br><span class="line">        <span class="comment">// broadcasts</span></span><br><span class="line">        <span class="type">int</span>[] userIds = &#123; UserHandle.USER_ALL, UserHandle.getUserId(callingUid) &#125;;</span><br><span class="line">        <span class="keyword">while</span> (actions.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> actions.next();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> id : userIds) &#123;</span><br><span class="line">                ArrayMap&lt;String, ArrayList&lt;StickyBroadcast&gt;&gt; stickies =</span><br><span class="line">                        mStickyBroadcasts.get(id);</span><br><span class="line">                <span class="keyword">if</span> (stickies != <span class="literal">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;StickyBroadcast&gt; broadcasts = stickies.get(action);</span><br><span class="line">                    <span class="keyword">if</span> (broadcasts != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (stickyBroadcasts == <span class="literal">null</span>) &#123;</span><br><span class="line">                            stickyBroadcasts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        stickyBroadcasts.addAll(broadcasts);  <span class="comment">// 3</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dynamic receivers are exported by default for versions prior to T</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">exported</span> <span class="operator">=</span> (flags &amp; Context.RECEIVER_EXPORTED) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;StickyBroadcast&gt; allSticky = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (stickyBroadcasts != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> mContext.getContentResolver();</span><br><span class="line">        <span class="comment">// Look for any matching sticky broadcasts...</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, N = stickyBroadcasts.size(); i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">StickyBroadcast</span> <span class="variable">broadcast</span> <span class="operator">=</span> stickyBroadcasts.get(i);</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> broadcast.intent;</span><br><span class="line">            <span class="comment">// Don&#x27;t provided intents that aren&#x27;t available to instant apps.</span></span><br><span class="line">            <span class="keyword">if</span> (instantApp &amp;&amp;</span><br><span class="line">                    (intent.getFlags() &amp; Intent.FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If intent has scheme &quot;content&quot;, it will need to access</span></span><br><span class="line">            <span class="comment">// provider that needs to lock mProviderMap in ActivityThread</span></span><br><span class="line">            <span class="comment">// and also it may need to wait application response, so we</span></span><br><span class="line">            <span class="comment">// cannot lock ActivityManagerService here.</span></span><br><span class="line">            <span class="keyword">if</span> (filter.match(resolver, intent, <span class="literal">true</span>, TAG) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (allSticky == <span class="literal">null</span>) &#123;</span><br><span class="line">                    allSticky = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                allSticky.add(broadcast);  <span class="comment">// 4</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">ReceiverList</span> <span class="variable">rl</span> <span class="operator">=</span> mRegisteredReceivers.get(receiver.asBinder());  <span class="comment">// 5</span></span><br><span class="line">        <span class="keyword">if</span> (rl == <span class="literal">null</span>) &#123;</span><br><span class="line">            rl = <span class="keyword">new</span> <span class="title class_">ReceiverList</span>(<span class="built_in">this</span>, callerApp, callingPid, callingUid,</span><br><span class="line">                    userId, receiver);  <span class="comment">// 6</span></span><br><span class="line">            <span class="keyword">if</span> (rl.app != <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                rl.app.mReceivers.addReceiver(rl);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            mRegisteredReceivers.put(receiver.asBinder(), rl);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.uid != callingUid) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.pid != callingPid) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.userId != userId) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BroadcastFilter</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastFilter</span>(filter, rl, callerPackage, callerFeatureId,</span><br><span class="line">                receiverId, permission, callingUid, userId, instantApp, visibleToInstantApps,</span><br><span class="line">                exported);  <span class="comment">// 7</span></span><br><span class="line">        <span class="keyword">if</span> (rl.containsFilter(filter)) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rl.add(bf);  <span class="comment">// 8</span></span><br><span class="line">            ...</span><br><span class="line">            mReceiverResolver.addFilter(getPackageManagerInternal().snapshot(), bf);  <span class="comment">// 9</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> sticky;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处通过getRecordForAppLOSP()方法得到ProcessRecord类型的callerApp对象，它用于描述请求AMS注册广播接收者的Activity所在的应用程序进程。</p>
<p>在注释2处根据传入的IntentFilter类型filter得到actions列表，根据actions列表和userIds（userIds可以理解为应用程序的uid）得到所有的粘性广播的StickyBroadcast（StickyBroadcast里存了粘性广播的状态，包括Intent），并在注释3处传入到stickyBroadcasts中。接下来从stickyBroadcasts中找到匹配传入的参数filter的粘性广播的intent，在注释4处将这些intent存入到allSticky列表中，从这里可以看出粘性广播是存储在AMS中的。</p>
<p>注释5处获取ReceiverList列表，如果为空则在注释6处创建，ReceiverList继承自ArrayList，用来存储广播接收者。</p>
<p>在注释7处创建BroadcastFilter并传入此前创建的ReceiverList，BroadcastFilter用来描述注册的广播接收者，并在注释8处通过add()方法将自身添加到ReceiverList中。在注释9处将BroadcastFilter添加到IntentResolver类型的mReceiverResolver中，这样当AMS接收到广播时就可以从mReceiverResolver中找到对应的广播接收者了，从而达到了注册广播的目的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E5%B9%BF%E6%92%AD%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B/" data-id="cltjvv1bk000s8q2u3sds9bnh" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-根Activity的启动过程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/%E6%A0%B9Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.574Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="根Activity的启动过程"><a href="#根Activity的启动过程" class="headerlink" title="根Activity的启动过程"></a><center>根Activity的启动过程</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>Activity的启动过程分为两种，一种是根Activity的启动过程，另一种是普通Activity的启动过程。 根Activity指的是应用程序启动的第一个Activity，因此根Activity的启动过程一般情况下也可以理解为应用程序的启动过程。</p>
<p>原本四大组件的通信都是 AMS 来处理，后期AMS过于臃肿，将Activity相关工作转移到了ATMS中。</p>
<h4 id="Launcher请求ATMS过程"><a href="#Launcher请求ATMS过程" class="headerlink" title="Launcher请求ATMS过程"></a>Launcher请求ATMS过程</h4><p>Launcher启动后会将已安装应用程序的快捷图标显示到桌面上，这些应用程序的快捷图标就是启动根Activity的入口，当我们点击某个应用程序的快捷图标时，就会通过Launcher请求ATMS来启动该应用程序。</p>
<p><img src="https://s2.loli.net/2023/12/26/ySlvwHXFW9Kg2me.jpg"></p>
<p>当我们点击应用程序的快捷图标时，就会调用Launcher#startActivitySafely()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">packages/apps/Launcher3/src/com/android/launcher3/Launcher.java        </span><br><span class="line"><span class="keyword">public</span> RunnableList <span class="title function_">startActivitySafely</span><span class="params">(View v, Intent intent, ItemInfo item)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">RunnableList</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">super</span>.startActivitySafely(v, intent, item);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了super.startActivitySafely()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">StatefulActivity</span>&lt;STATE_TYPE <span class="keyword">extends</span> <span class="title class_">BaseState</span>&lt;STATE_TYPE&gt;&gt;</span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">BaseDraggingActivity</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseDraggingActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">OnColorsChangedListener</span>, DisplayInfoChangeListener &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">ActivityContext</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由继承关系可知，调用的是ActivityContext#startActivitySafely()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">packages/apps/Launcher3/src/com/android/launcher3/views/ActivityContext.java</span><br><span class="line"><span class="keyword">default</span> RunnableList <span class="title function_">startActivitySafely</span><span class="params">(</span></span><br><span class="line"><span class="params">        View v, Intent intent, <span class="meta">@Nullable</span> ItemInfo item)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Prepare intent</span></span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);  <span class="comment">// 1</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isShortcut</span> <span class="operator">=</span> (item <span class="keyword">instanceof</span> WorkspaceItemInfo)</span><br><span class="line">                &amp;&amp; (item.itemType == LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT</span><br><span class="line">                || item.itemType == LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT)</span><br><span class="line">                &amp;&amp; !((WorkspaceItemInfo) item).isPromise();</span><br><span class="line">        <span class="keyword">if</span> (isShortcut) &#123;</span><br><span class="line">            <span class="comment">// Shortcuts need some special checks due to legacy reasons.</span></span><br><span class="line">            startShortcutIntentSafely(intent, optsBundle, item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user == <span class="literal">null</span> || user.equals(Process.myUserHandle())) &#123;</span><br><span class="line">            <span class="comment">// Could be launching some bookkeeping activity</span></span><br><span class="line">            context.startActivity(intent, optsBundle);  <span class="comment">// 2</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context.getSystemService(LauncherApps.class).startMainActivity(</span><br><span class="line">                    intent.getComponent(), user, intent.getSourceBounds(), optsBundle);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> options.onEndCallback;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException | ActivityNotFoundException | SecurityException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处将Flag设置为Intent.FLAG_ACTIVITY_NEW_TASK，这样根Activity会在新的任务栈中启动；</p>
<p>注释2处会调用Context#startActivity()，Context是抽象类，其中定义了抽象方法startActivity()，在其子类Activity中实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startActivity</span><span class="params">(Intent intent, <span class="meta">@Nullable</span> Bundle options)</span> &#123;</span><br><span class="line">    getAutofillClientController().onStartActivity(intent, mIntent);</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在startActivity()中调用startActivityForResult()，它的第二个参数为-1，表示Launcher不需要知道Activity启动的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startActivityForResult</span><span class="params">(<span class="meta">@RequiresPermission</span> Intent intent, <span class="type">int</span> requestCode,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Bundle options)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="literal">null</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        Instrumentation.<span class="type">ActivityResult</span> <span class="variable">ar</span> <span class="operator">=</span></span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="built_in">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处的mParent是Activity类型的，表示当前Activity的父类。因为目前根Activity还没有创建出来，因此，mParent &#x3D;&#x3D; null为true。接着调用Instrumentation#execStartActivity()。Instrumentation主要用来监控应用程序和系统的交互。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="keyword">public</span> ActivityResult <span class="title function_">execStartActivity</span><span class="params">(</span></span><br><span class="line"><span class="params">        Context who, IBinder contextThread, IBinder token, Activity target,</span></span><br><span class="line"><span class="params">        Intent intent, <span class="type">int</span> requestCode, Bundle options)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ActivityTaskManager.getService().startActivity(whoThread,</span><br><span class="line">                who.getOpPackageName(), who.getAttributionTag(), intent,</span><br><span class="line">                intent.resolveTypeIfNeeded(who.getContentResolver()), token,</span><br><span class="line">                target != <span class="literal">null</span> ? target.mEmbeddedID : <span class="literal">null</span>, requestCode, <span class="number">0</span>, <span class="literal">null</span>, options);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先调用ActivityTaskManager#getService()来获取ATMS的代理对象，接着调用startActivity()。</p>
<p>先来看一下ActivityTaskManager#getService()做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityTaskManager.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IActivityTaskManager <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IActivityTaskManagerSingleton.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Singleton</span>&lt;IActivityTaskManager&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> IActivityTaskManager <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);  <span class="comment">// 1</span></span><br><span class="line">                    <span class="keyword">return</span> IActivityTaskManager.Stub.asInterface(b);  <span class="comment">// 2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure>

<p>getService()调用了IActivityTaskManagerSingleton#get()。IActivityTaskManagerSingleton是一个Singleton类。在注释1处得到名为”activity_task”的Service引用，也就是IBinder类型的ATMS引用。接着在注释2处将它转换为IActivityTaskManager类型的对象。这段代码采用的是AIDL，IActivityTaskManager.java类是由AIDL工具在编译时自动生成的，IActivityTaskManager.aidl的文件路径是frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;app&#x2F;IActivityTaskManager.aidl。要实现进程间通信，服务器端也就是ATMS只需要继承IActivityTaskManager.Stub类并实现相应的方法就可以了。</p>
<p>回到Instrumentation类的execStartActivity()方法中，从上面得知execStartActivity()最终调用的是ATMS的startActivity()方法。</p>
<h4 id="ATMS到ApplicationThread的调用过程"><a href="#ATMS到ApplicationThread的调用过程" class="headerlink" title="ATMS到ApplicationThread的调用过程"></a>ATMS到ApplicationThread的调用过程</h4><p><img src="https://s2.loli.net/2023/12/26/BetXHFSLwp5RONE.jpg"></p>
<p>Launcher请求ATMS之后，代码逻辑已经进入ATMS中，接着是ATMS到ApplicationThread的调用流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="line"><span class="params">        String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,</span></span><br><span class="line"><span class="params">        String resultWho, <span class="type">int</span> requestCode, <span class="type">int</span> startFlags, ProfilerInfo profilerInfo,</span></span><br><span class="line"><span class="params">        Bundle bOptions)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,</span><br><span class="line">            resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在ATMS#startActivity()中返回了startActivityAsUser()方法，startActivityAsUser()比startActivity()多了一个参数UserHandle.getCallingUserId()，这个方法会获得调用者的UserId。ATMS根据这个UserId来确定调用者的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="line"><span class="params">        String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,</span></span><br><span class="line"><span class="params">        String resultWho, <span class="type">int</span> requestCode, <span class="type">int</span> startFlags, ProfilerInfo profilerInfo,</span></span><br><span class="line"><span class="params">        Bundle bOptions, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,</span><br><span class="line">            resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions, userId,</span><br><span class="line">            <span class="literal">true</span> <span class="comment">/*validateIncomingUser*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> String callingFeatureId, Intent intent, String resolvedType,</span></span><br><span class="line"><span class="params">        IBinder resultTo, String resultWho, <span class="type">int</span> requestCode, <span class="type">int</span> startFlags,</span></span><br><span class="line"><span class="params">        ProfilerInfo profilerInfo, Bundle bOptions, <span class="type">int</span> userId, <span class="type">boolean</span> validateIncomingUser)</span> &#123;</span><br><span class="line">   </span><br><span class="line">    ...</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">&quot;startActivityAsUser&quot;</span>);  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    userId = getActivityStartController().checkTargetUser(userId, validateIncomingUser,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="string">&quot;startActivityAsUser&quot;</span>);  <span class="comment">// 2</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">return</span> getActivityStartController().obtainStarter(intent, <span class="string">&quot;startActivityAsUser&quot;</span>)</span><br><span class="line">            .setCaller(caller)</span><br><span class="line">            .setCallingPackage(callingPackage)</span><br><span class="line">            .setCallingFeatureId(callingFeatureId)</span><br><span class="line">            .setResolvedType(resolvedType)</span><br><span class="line">            .setResultTo(resultTo)</span><br><span class="line">            .setResultWho(resultWho)</span><br><span class="line">            .setRequestCode(requestCode)</span><br><span class="line">            .setStartFlags(startFlags)</span><br><span class="line">            .setProfilerInfo(profilerInfo)</span><br><span class="line">            .setActivityOptions(opts)</span><br><span class="line">            .setUserId(userId)</span><br><span class="line">            .execute();  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处判断调用者进程是否被隔离，如果被隔离则抛出SecurityException异常；</p>
<p>注释2处检查调用者是否有权限，如果没有权限也会抛出SecurityException异常；</p>
<p>注释3处通过ActivityStartController来获取一个ActivityStarter，并且配置了一些参数。</p>
<p>ActivityStarter是加载Activity的控制类，会收集所有的逻辑来决定如何将Intent和Flags转换为Activity，并将Activity和Task相关联。execute()根据请求参数解析信息，executeRequest()执行一系列权限检查，对于合法的请求才继续。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><span class="line"><span class="type">int</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    res = executeRequest(mRequest);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">executeRequest</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IApplicationThread</span> <span class="variable">caller</span> <span class="operator">=</span> request.caller;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">WindowProcessController</span> <span class="variable">callerApp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="literal">null</span>) &#123;  <span class="comment">// 1</span></span><br><span class="line">        callerApp = mService.getProcessController(caller);  <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">if</span> (callerApp != <span class="literal">null</span>) &#123;</span><br><span class="line">            callingPid = callerApp.getPid();</span><br><span class="line">            callingUid = callerApp.mInfo.uid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityRecord</span>.Builder(mService)</span><br><span class="line">            .setCaller(callerApp)</span><br><span class="line">            .setLaunchedFromPid(callingPid)</span><br><span class="line">            .setLaunchedFromUid(callingUid)</span><br><span class="line">            .setLaunchedFromPackage(callingPackage)</span><br><span class="line">            .setLaunchedFromFeature(callingFeatureId)</span><br><span class="line">            .setIntent(intent)</span><br><span class="line">            .setResolvedType(resolvedType)</span><br><span class="line">            .setActivityInfo(aInfo)</span><br><span class="line">            .setConfiguration(mService.getGlobalConfiguration())</span><br><span class="line">            .setResultTo(resultRecord)</span><br><span class="line">            .setResultWho(resultWho)</span><br><span class="line">            .setRequestCode(requestCode)</span><br><span class="line">            .setComponentSpecified(request.componentSpecified)</span><br><span class="line">            .setRootVoiceInteraction(voiceSession != <span class="literal">null</span>)</span><br><span class="line">            .setActivityOptions(checkedOptions)</span><br><span class="line">            .setSourceRecord(sourceRecord)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    mLastStartActivityRecord = r;</span><br><span class="line">    ...</span><br><span class="line">    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class="line">            request.voiceInteractor, startFlags, checkedOptions,</span><br><span class="line">            inTask, inTaskFragment, balCode, intentGrants, realCallingUid);  <span class="comment">// 3</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> mLastStartActivityResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法中会执行一些初步的检查。</p>
<p>注释1处判断IApplicationThread类型的caller是否为null，caller指向的是Launcher所在的应用程序进程的ApplicationThread对象；</p>
<p>注释2处ActivityTaskManagerService#getProcessController()得到WindowProcessController对象，进一步获取Launcher进程的pid和uid；</p>
<p>接下来创建ActivityRecord，用于描述将要启动的Activity，然后注释3处调用startActivityUnchecked()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span><br><span class="line"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> startFlags, ActivityOptions options, Task inTask,</span></span><br><span class="line"><span class="params">        TaskFragment inTaskFragment, <span class="meta">@BalCode</span> <span class="type">int</span> balCode,</span></span><br><span class="line"><span class="params">        NeededUriGrants intentGrants, <span class="type">int</span> realCallingUid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> START_CANCELED;</span><br><span class="line">    <span class="keyword">final</span> Task startedActivityRootTask;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                startFlags, options, inTask, inTaskFragment, balCode,</span><br><span class="line">                intentGrants, realCallingUid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用startActivityUnchecked()时表示大部分初步的权限检查已经完成，执行Trace，以及异常处理。<br>接着调用startActivityInner()启动Activity，并更新全局的Task栈帧信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><span class="line"><span class="type">int</span> <span class="title function_">startActivityInner</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span><br><span class="line"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> startFlags, ActivityOptions options, Task inTask,</span></span><br><span class="line"><span class="params">        TaskFragment inTaskFragment, <span class="meta">@BalCode</span> <span class="type">int</span> balCode,</span></span><br><span class="line"><span class="params">        NeededUriGrants intentGrants, <span class="type">int</span> realCallingUid)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里设置了一些属性，包括mDoResume</span></span><br><span class="line">    setInitialState(r, options, inTask, inTaskFragment, startFlags, sourceRecord,</span><br><span class="line">            voiceSession, voiceInteractor, balCode, realCallingUid);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">topTaskActivity</span> <span class="operator">=</span> startedTask.topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (!mTargetRootTask.isTopActivityFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="literal">null</span> &amp;&amp; topTaskActivity.isTaskOverlay()</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mAvoidMoveToFront &amp;&amp; mTargetRootTask.isTopActivityFocusable()</span><br><span class="line">                    &amp;&amp; !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) &#123;</span><br><span class="line">                mTargetRootTask.moveToFront(<span class="string">&quot;startActivityInner&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRootWindowContainer.resumeFocusedTasksTopActivities(  <span class="comment">// 1</span></span><br><span class="line">                    mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>startActivityInner()用于启动 Activity，并更新全局的task栈帧信息，如处理singleTop、singleInstance问题，计算Intent Flag，以及栈顶复用问题等。接着调用RootWindowContainer#resumeFocusedTasksTopActivities()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">resumeFocusedTasksTopActivities</span><span class="params">(</span></span><br><span class="line"><span class="params">        Task targetRootTask, ActivityRecord target, ActivityOptions targetOptions,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> deferPause)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (targetRootTask != <span class="literal">null</span> &amp;&amp; (targetRootTask.isTopRootTaskInDisplayArea()</span><br><span class="line">            || getTopDisplayFocusedRootTask() == targetRootTask)) &#123;</span><br><span class="line">        result = targetRootTask.resumeTopActivityUncheckedLocked(target, targetOptions,</span><br><span class="line">                deferPause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">displayNdx</span> <span class="operator">=</span> getChildCount() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!resumedOnDisplay[<span class="number">0</span>]) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Task</span> <span class="variable">focusedRoot</span> <span class="operator">=</span> display.getFocusedRootTask();</span><br><span class="line">            <span class="keyword">if</span> (focusedRoot != <span class="literal">null</span>) &#123;</span><br><span class="line">                result |= focusedRoot.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetRootTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                result |= resumeHomeActivity(<span class="literal">null</span> <span class="comment">/* prev */</span>, <span class="string">&quot;no-focusable-task&quot;</span>,</span><br><span class="line">                        display.getDefaultTaskDisplayArea());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>resumeFocusedTasksTopActivities()将所有聚焦的Task的所有Activity恢复运行，因为有些刚加入的Activity是处于暂停状态的。resumeFocusedTasksTopActivities()中主要是判断传入的targetRootTask是否等于当前栈顶的 Task，不管是否相等，后续都是调用栈顶Task的resumeTopActivityUncheckedLocked()方法，启动栈顶Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/Task.java</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resumeTopActivityUncheckedLocked(prev, options, <span class="literal">false</span> <span class="comment">/* skipPause */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> deferPause)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mInResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="variable">someActivityResumed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 确保只有一个Activity执行该方法</span></span><br><span class="line">        mInResumeTopActivity = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isLeafTask()) &#123;  <span class="comment">// 叶子节点</span></span><br><span class="line">            <span class="keyword">if</span> (isFocusableAndVisible()) &#123;</span><br><span class="line">                someActivityResumed = resumeTopActivityInnerLocked(prev, options, deferPause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> mChildren.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (idx &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Task</span> <span class="variable">child</span> <span class="operator">=</span> (Task) getChildAt(idx--);</span><br><span class="line">                ...</span><br><span class="line">                someActivityResumed |= child.resumeTopActivityUncheckedLocked(prev, options,</span><br><span class="line">                        deferPause);  <span class="comment">// 非叶子节点</span></span><br><span class="line">                <span class="keyword">if</span> (idx &gt;= mChildren.size()) &#123;</span><br><span class="line">                    idx = mChildren.size() - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mInResumeTopActivity = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> someActivityResumed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>resumeTopActivityUncheckedLocked()对 Task 进行了一次判断，如果是非叶子结点，则对所有子结点递归调用本方法，递归结束（即到达叶子结点）后才继续实际流程，然后进入到 resumeTopActivityInnerLocked()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/Task.java</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> deferPause)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityRecord</span> <span class="variable">topActivity</span> <span class="operator">=</span> topRunningActivity(<span class="literal">true</span> <span class="comment">/* focusableOnly */</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span>[] resumed = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TaskFragment</span> <span class="variable">topFragment</span> <span class="operator">=</span> topActivity.getTaskFragment();</span><br><span class="line">    resumed[<span class="number">0</span>] = topFragment.resumeTopActivity(prev, options, deferPause);</span><br><span class="line">    forAllLeafTaskFragments(f -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (topFragment == f) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!f.canBeResumed(<span class="literal">null</span> <span class="comment">/* starting */</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        resumed[<span class="number">0</span>] |= f.resumeTopActivity(prev, options, deferPause);</span><br><span class="line">    &#125;, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> resumed[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用TaskFragment#resumeTopActivity()。该方法主要是寻找合适的 ActivityRecord、设置 resume 条件、准备启动目标 Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/TaskFragment.java</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">resumeTopActivity</span><span class="params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> deferPause)</span> &#123;</span><br><span class="line">    <span class="type">ActivityRecord</span> <span class="variable">next</span> <span class="operator">=</span> topRunningActivity(<span class="literal">true</span> <span class="comment">/* focusableOnly */</span>);</span><br><span class="line">    <span class="keyword">if</span> (next == <span class="literal">null</span> || !next.canResumeByCompat()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next.delayedResume = <span class="literal">false</span>;</span><br><span class="line">    ...</span><br><span class="line">   <span class="keyword">if</span> (next.attachedToProcess()) &#123;  <span class="comment">// Activity已经附加到进程，恢复页面并更新栈</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">            ...</span><br><span class="line">            mTaskSupervisor.startSpecificActivity(next, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 栈顶Activity没有与已有的进程关联，需要启动目标Activity。</span></span><br><span class="line">        <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">        ...</span><br><span class="line">        mTaskSupervisor.startSpecificActivity(next, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 ActivityTaskSupervisor#startSpecificActivity()启动新进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/ActivityTaskSupervisor.java</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startSpecificActivity</span><span class="params">(ActivityRecord r, <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span> &#123;</span><br><span class="line">    <span class="comment">// Is this activity&#x27;s application already running?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">WindowProcessController</span> <span class="variable">wpc</span> <span class="operator">=</span></span><br><span class="line">                mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (wpc != <span class="literal">null</span> &amp;&amp; wpc.hasThread()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    mService.startProcessAsync(r, knownToBeDead, isTop,</span><br><span class="line">            isTop ? HostingRecord.HOSTING_TYPE_TOP_ACTIVITY</span><br><span class="line">                    : HostingRecord.HOSTING_TYPE_ACTIVITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进程已存在时执行realStartActivityLocked()，进程不存在时执行ActivityTaskManagerService#startProcessAsync()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/ActivityTaskSupervisor.java</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">realStartActivityLocked</span><span class="params">(ActivityRecord r, WindowProcessController proc,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;      </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ClientTransaction</span> <span class="variable">clientTransaction</span> <span class="operator">=</span> ClientTransaction.obtain(</span><br><span class="line">                    proc.getThread(), r.token);  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isTransitionForward</span> <span class="operator">=</span> r.isTransitionForward();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">fragmentToken</span> <span class="operator">=</span> r.getTaskFragment().getFragmentToken();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">deviceId</span> <span class="operator">=</span> getDeviceIdForDisplayId(r.getDisplayId());</span><br><span class="line">            clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> <span class="title class_">Intent</span>(r.intent),</span><br><span class="line">                    System.identityHashCode(r), r.info,</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                    <span class="comment">// and override configs.</span></span><br><span class="line">                    mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                    mergedConfiguration.getOverrideConfiguration(), deviceId,</span><br><span class="line">                    r.getFilteredReferrer(r.launchedFromPackage), task.voiceInteractor,</span><br><span class="line">                    proc.getReportedProcState(), r.getSavedState(), r.getPersistentSavedState(),</span><br><span class="line">                    results, newIntents, r.takeOptions(), isTransitionForward,</span><br><span class="line">                    proc.createProfilerInfoIfNeeded(), r.assistToken, activityClientController,</span><br><span class="line">                    r.shareableActivityToken, r.getLaunchedFromBubble(), fragmentToken));  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set desired final state.</span></span><br><span class="line">            <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">            <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                lifecycleItem = ResumeActivityItem.obtain(isTransitionForward,</span><br><span class="line">                        r.shouldSendCompatFakeFocus());  <span class="comment">// 3</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">            &#125;</span><br><span class="line">            clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Schedule transaction.</span></span><br><span class="line">            mService.getLifecycleManager().scheduleTransaction(clientTransaction);  <span class="comment">// 4</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建一个启动Activity事务；</p>
<p>注释2处添加Callback，这里创建的是LaunchActivityItem；</p>
<p>注释3处设置此次事务应该执行的最终状态，此次流程会设置为resume，表示Activity应该执行到onResume状态。设置ResumeActivityItem到clientTransaction中。</p>
<p>注释4处执行事务。</p>
<p>Activity的启动会通过事务来完成，事务通过目标App的IApplicationThread远程发送到目标App中，然后通过ClientLifecycleManager来执行。至此ATMS中执行的逻辑就结束了，剩下的就是目标App的ApplicationThread来执行目标Activity的各个生命周期方法了。</p>
<h4 id="ApplicationThread启动Activity的过程"><a href="#ApplicationThread启动Activity的过程" class="headerlink" title="ApplicationThread启动Activity的过程"></a>ApplicationThread启动Activity的过程</h4><p><img src="https://s2.loli.net/2023/12/26/potvWX975KZszad.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/ClientLifecycleManager.java</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IApplicationThread</span> <span class="variable">client</span> <span class="operator">=</span> transaction.getClient();</span><br><span class="line">    transaction.schedule();</span><br><span class="line">    <span class="keyword">if</span> (!(client <span class="keyword">instanceof</span> Binder)) &#123;</span><br><span class="line">        <span class="comment">// If client is not an instance of Binder - it&#x27;s a remote call and at this point it is</span></span><br><span class="line">        <span class="comment">// safe to recycle the object. All objects used for local calls will be recycled after</span></span><br><span class="line">        <span class="comment">// the transaction is executed on client in ActivityThread.</span></span><br><span class="line">        transaction.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行ClientTransaction#schedule()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">schedule</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    mClient.scheduleTransaction(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行ApplicationThread#scheduleTransaction()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread$ApplicationThread</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ActivityThread.<span class="built_in">this</span>.scheduleTransaction(transaction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用ActivityThread的scheduleTransaction()方法，ActivityThread继承自ClientTransactionHandler，实际调用的是ClientTransactionHandler的scheduleTransaction()方法，传入了创建好的transaction对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ClientTransactionHandler.java</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> &#123;</span><br><span class="line">    transaction.preExecute(<span class="built_in">this</span>);</span><br><span class="line">    sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用sendMessage()方法，这里通过Handler发送了一个EXECUTE_TRANSACTION消息，会交给ActivityThread的H类来处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">TransactionExecutor</span> <span class="variable">mTransactionExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionExecutor</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">H</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ClientTransaction</span> <span class="variable">transaction</span> <span class="operator">=</span> (ClientTransaction) msg.obj;</span><br><span class="line">                mTransactionExecutor.execute(transaction);</span><br><span class="line">                <span class="keyword">if</span> (isSystem()) &#123;</span><br><span class="line">                    <span class="comment">// Client transactions inside system process are recycled on the client side</span></span><br><span class="line">                    <span class="comment">// instead of ClientLifecycleManager to avoid being cleared before this</span></span><br><span class="line">                    <span class="comment">// message is handled.</span></span><br><span class="line">                    transaction.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在handleMessage()回调方法中执行EXECUTE_TRANSACTION对应的case。首先取出ClientTransaction对象，然后调用mTransactionExecutor的execute()方法，mTransactionExecutor是一个TransactionExecutor对象，是用来处理Transaction的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ClientTransaction transaction)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">token</span> <span class="operator">=</span> transaction.getActivityToken();</span><br><span class="line">    ...</span><br><span class="line">    executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">    executeLifecycleState(transaction);</span><br><span class="line">    mPendingActions.clear();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class="string">&quot;End resolving transaction&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>顺序执行executeCallbacks()和executeLifecycleState()方法。</p>
<ol>
<li><p>executeCallbacks()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeCallbacks</span><span class="params">(ClientTransaction transaction)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;ClientTransactionItem&gt; callbacks = transaction.getCallbacks();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> callbacks.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClientTransactionItem</span> <span class="variable">item</span> <span class="operator">=</span> callbacks.get(i);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        item.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先从系统进程传来的ClientTransaction中得到mActivityCallbacks列表，里面保存了一个LaunchActivityItem。接着通过遍历取出这个LaunchActivityItem，接着调用它的execute()方法，传入的第一个参数是持有的ActivityThread对象，第二个参数token是从系统进程传来的activityToken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/LaunchActivityItem.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span><br><span class="line"><span class="params">        PendingTransactionActions pendingActions)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityClientRecord</span>(token, mIntent, mIdent, mInfo,</span><br><span class="line">            mOverrideConfig, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">            mPendingResults, mPendingNewIntents, mActivityOptions, mIsForward, mProfilerInfo,</span><br><span class="line">            client, mAssistToken, mShareableActivityToken, mLaunchedFromBubble,</span><br><span class="line">            mTaskFragmentToken);</span><br><span class="line">    client.handleLaunchActivity(r, pendingActions, mDeviceId, <span class="literal">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了ActivityThread类的handleLaunchActivity()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> Activity <span class="title function_">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span><br><span class="line"><span class="params">        PendingTransactionActions pendingActions, <span class="type">int</span> deviceId, Intent customIntent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="literal">null</span>) &#123;</span><br><span class="line">        r.createdConfig = <span class="keyword">new</span> <span class="title class_">Configuration</span>(mConfigurationController.getConfiguration());</span><br><span class="line">        reportSizeConfigurations(r);</span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; pendingActions != <span class="literal">null</span>) &#123;</span><br><span class="line">            pendingActions.setOldState(r.state);</span><br><span class="line">            pendingActions.setRestoreInstanceState(<span class="literal">true</span>);</span><br><span class="line">            pendingActions.setCallOnPostCreate(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续调用performLaunchActivity()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r);</span><br><span class="line">    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> appContext.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);  <span class="comment">// 1</span></span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),</span><br><span class="line">                appContext.getAttributionSource());</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplicationInner(<span class="literal">false</span>, mInstrumentation);  <span class="comment">// 2</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window, r.activityConfigCallback,</span><br><span class="line">                    r.assistToken, r.shareableActivityToken);  <span class="comment">// 3</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 4</span></span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建Activity实例，这里的Activity指的是我们要启动的新的XXXActivity。调用了Instrumentation类的newActivity()方法；</p>
<p>注释2处尝试创建Application，r.packageInfo返回的是LoadedApk对象，调用了LoadApk的makeApplicationInner()方法。如果之前在bindApplication的时候已经创建了Application，这里直接返回之前创建的Application。</p>
<p>注释3处创建Activity的PhoneWindow，并将当前线程设置成主线程。我们在这个fork出来的新进程中还没有创建其他线程，这个Activity也是该App启动的第一个Activity，所以这个Activity就是在主线程中运行的。</p>
<p>注释4处调用了Instrumentation的callActivityOnCreate()，执行新Activity的onCreate生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> &#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performCreate</span><span class="params">(Bundle icicle)</span> &#123;</span><br><span class="line">    performCreate(icicle, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    dispatchActivityPreCreated(icicle);</span><br><span class="line">    mCanEnterPictureInPicture = <span class="literal">true</span>;</span><br><span class="line">    ...</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">    <span class="keyword">if</span> (persistentState != <span class="literal">null</span>) &#123;</span><br><span class="line">        onCreate(icicle, persistentState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onCreate(icicle);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>executeLifecycleState()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeLifecycleState</span><span class="params">(ClientTransaction transaction)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityLifecycleItem</span> <span class="variable">lifecycleItem</span> <span class="operator">=</span> transaction.getLifecycleStateRequest();  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (lifecycleItem == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No lifecycle request, return early.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">token</span> <span class="operator">=</span> transaction.getActivityToken();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> mTransactionHandler.getActivityClient(token);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESOLVER) &#123;</span><br><span class="line">        Slog.d(TAG, tId(transaction) + <span class="string">&quot;Resolving lifecycle state: &quot;</span></span><br><span class="line">                + lifecycleItem + <span class="string">&quot; for activity: &quot;</span></span><br><span class="line">                + getShortActivityName(token, mTransactionHandler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Ignore requests for non-existent client records for now.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cycle to the state right before the final requested state.</span></span><br><span class="line">    cycleToPath(r, lifecycleItem.getTargetState(), <span class="literal">true</span> <span class="comment">/* excludeLastState */</span>, transaction);  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the final transition with proper parameters.</span></span><br><span class="line">    lifecycleItem.execute(mTransactionHandler, token, mPendingActions);  <span class="comment">// 3</span></span><br><span class="line">    lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处获取的是之前添加的ResumeActivityItem；</p>
<p>注释2处cycleToPath()非常重要，其中的lifecycleItem.getTargetState()返回值是ON_RESUME；</p>
<p>注释3处执行ResumeActivityItem的execute()。</p>
<ol start="2">
<li><p>1 onStart()阶段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cycleToPath</span><span class="params">(ActivityClientRecord r, <span class="type">int</span> finish, <span class="type">boolean</span> excludeLastState,</span></span><br><span class="line"><span class="params">        ClientTransaction transaction)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> r.getLifecycleState();  <span class="comment">// 1</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IntArray</span> <span class="variable">path</span> <span class="operator">=</span> mHelper.getLifecyclePath(start, finish, excludeLastState);  <span class="comment">// 2</span></span><br><span class="line">    performLifecycleSequence(r, path, transaction);  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutorHelper.java</span><br><span class="line"><span class="keyword">public</span> IntArray <span class="title function_">getLifecyclePath</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> finish, <span class="type">boolean</span> excludeLastState)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == UNDEFINED || finish == UNDEFINED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can&#x27;t resolve lifecycle path for undefined state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (start == ON_RESTART || finish == ON_RESTART) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                <span class="string">&quot;Can&#x27;t start or finish in intermittent RESTART state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (finish == PRE_ON_CREATE &amp;&amp; start != finish) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can only start in pre-onCreate state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLifecycleSequence.clear();</span><br><span class="line">    <span class="keyword">if</span> (finish &gt;= start) &#123;</span><br><span class="line">        <span class="keyword">if</span> (start == ON_START &amp;&amp; finish == ON_STOP) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// just go there</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start + <span class="number">1</span>; i &lt;= finish; i++) &#123;  <span class="comment">// 4</span></span><br><span class="line">                mLifecycleSequence.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// finish &lt; start, can&#x27;t just cycle down</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove last transition in case we want to perform it with some specific params.</span></span><br><span class="line">    <span class="keyword">if</span> (excludeLastState &amp;&amp; mLifecycleSequence.size() != <span class="number">0</span>) &#123;  <span class="comment">// 5</span></span><br><span class="line">        mLifecycleSequence.remove(mLifecycleSequence.size() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mLifecycleSequence;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处的start是ON_CREATE；</p>
<p>注释2处finish是ON_RESUME，path是ON_START，这里是Activity执行onStart()函数的关键所在；</p>
<p>注释3处执行path中的相关的生命周期函数；</p>
<p>注释4处把ON_START和ON_RESUME添加到mLifecycleSequence中；</p>
<p>注释5处因为excludeLastState为true，所以删除掉ON_RESUME状态，只保留了ON_START。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performLifecycleSequence</span><span class="params">(ActivityClientRecord r, IntArray path,</span></span><br><span class="line"><span class="params">        ClientTransaction transaction)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> path.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, state; i &lt; size; i++) &#123;</span><br><span class="line">        state = path.get(i);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_RESOLVER) &#123;</span><br><span class="line">            Slog.d(TAG, tId(transaction) + <span class="string">&quot;Transitioning activity: &quot;</span></span><br><span class="line">                    + getShortActivityName(r.token, mTransactionHandler)</span><br><span class="line">                    + <span class="string">&quot; to state: &quot;</span> + getStateName(state));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">                mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class="line">                        Context.DEVICE_ID_INVALID, <span class="literal">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_START:</span><br><span class="line">                mTransactionHandler.handleStartActivity(r, mPendingActions,</span><br><span class="line">                        <span class="literal">null</span> <span class="comment">/* activityOptions */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">                mTransactionHandler.handleResumeActivity(r, <span class="literal">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                        r.isForward, <span class="literal">false</span> <span class="comment">/* shouldSendCompatFakeFocus */</span>,</span><br><span class="line">                        <span class="string">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">                mTransactionHandler.handlePauseActivity(r, <span class="literal">false</span> <span class="comment">/* finished */</span>,</span><br><span class="line">                        <span class="literal">false</span> <span class="comment">/* userLeaving */</span>, <span class="number">0</span> <span class="comment">/* configChanges */</span>,</span><br><span class="line">                        <span class="literal">false</span> <span class="comment">/* autoEnteringPip */</span>, mPendingActions,</span><br><span class="line">                        <span class="string">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_STOP:</span><br><span class="line">                mTransactionHandler.handleStopActivity(r, <span class="number">0</span> <span class="comment">/* configChanges */</span>,</span><br><span class="line">                        mPendingActions, <span class="literal">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                        <span class="string">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">                mTransactionHandler.handleDestroyActivity(r, <span class="literal">false</span> <span class="comment">/* finishing */</span>,</span><br><span class="line">                        <span class="number">0</span> <span class="comment">/* configChanges */</span>, <span class="literal">false</span> <span class="comment">/* getNonConfigInstance */</span>,</span><br><span class="line">                        <span class="string">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_RESTART:</span><br><span class="line">                mTransactionHandler.performRestartActivity(r, <span class="literal">false</span> <span class="comment">/* start */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unexpected lifecycle state: &quot;</span> + state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>state为ON_START，执行ActivityThread#handleStartActivity()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStartActivity</span><span class="params">(ActivityClientRecord r,</span></span><br><span class="line"><span class="params">        PendingTransactionActions pendingActions, ActivityOptions activityOptions)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Start</span></span><br><span class="line">    activity.performStart(<span class="string">&quot;handleStartActivity&quot;</span>);</span><br><span class="line">    r.setState(ON_START);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performStart</span><span class="params">(String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="built_in">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnStart</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调用了Acitvity#onStart()。</p>
<ol start="2">
<li><p>2 onResume()阶段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/ResumeActivityItem.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ClientTransactionHandler client, ActivityClientRecord r,</span></span><br><span class="line"><span class="params">        PendingTransactionActions pendingActions)</span> &#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityResume&quot;</span>);</span><br><span class="line">    client.handleResumeActivity(r, <span class="literal">true</span> <span class="comment">/* finalStateRequest */</span>, mIsForward,</span><br><span class="line">            mShouldSendCompatFakeFocus, <span class="string">&quot;RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">    Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行ActivityThread#handleStartActivity()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResumeActivity</span><span class="params">(ActivityClientRecord r, <span class="type">boolean</span> finalStateRequest,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> isForward, <span class="type">boolean</span> shouldSendCompatFakeFocus, String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!performResumeActivity(r, finalStateRequest, reason)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">performResumeActivity</span><span class="params">(ActivityClientRecord r, <span class="type">boolean</span> finalStateRequest,</span></span><br><span class="line"><span class="params">        String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">performResume</span><span class="params">(<span class="type">boolean</span> followedByPause, String reason)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    mInstrumentation.callActivityOnResume(<span class="built_in">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callActivityOnResume</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    activity.mResumed = <span class="literal">true</span>;</span><br><span class="line">    activity.onResume();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调用了Acitvity#onResume()。</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/%E6%A0%B9Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" data-id="cltjvv1bl000w8q2u6ly96cfh" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Zygote启动流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/Zygote%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.573Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Zygote启动流程"><a href="#Zygote启动流程" class="headerlink" title="Zygote启动流程"></a><center>Zygote启动流程</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>Zygote是由Init进程通过解析init.zygote.rc文件而创建的，Zygote所对应的可执行程序是app_process，所对应的源文件是app_main.cpp，进程名为zygote。Zygote启动过程的时序图如下：</p>
<p><img src="https://s2.loli.net/2023/12/26/iaxbjwnLkFK6753.jpg"></p>
<h3 id="app-main"><a href="#app-main" class="headerlink" title="app_main"></a>app_main</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/cmds/app_process/app_main.<span class="function">cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* <span class="type">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 参数解析</span></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 根据参数，设置对应标志位</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--zygote&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--start-system-server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">&quot;--application&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--nice-name=&quot;</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.<span class="built_in">setTo</span>(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">&quot;--&quot;</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.<span class="built_in">setTo</span>(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (!niceName.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        runtime.<span class="built_in">setArgv0</span>(niceName.<span class="built_in">string</span>(), <span class="literal">true</span> <span class="comment">/* setProcName */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;  <span class="comment">// 如果运行在Zygote进程中</span></span><br><span class="line">        runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.<span class="built_in">start</span>(<span class="string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">app_usage</span>();</span><br><span class="line">        <span class="built_in">LOG_ALWAYS_FATAL</span>(<span class="string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Zygote进程都是通过fork自身来创建子进程的，这样Zygote进程以及它的子进程都可以进入app_main.cpp的main函数，因此main函数中为了区分当前运行在哪个进程，会判断参数arg中是否包含了”–zygote”，如果包含了则说明main函数是运行在Zygote进程中的；如果包含了”–start-system-server”，则说明main函数是运行在SystemServer进程中。</li>
<li>runtime是AppRuntime对象，AppRuntime中没有对应函数，而AppRuntime继承自AndroidRuntime，所以<code>runtime.start()</code>调用的是AndroidRuntime类中的start函数。</li>
</ul>
<h3 id="AndroidRuntime"><a href="#AndroidRuntime" class="headerlink" title="AndroidRuntime"></a>AndroidRuntime</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/jni/AndroidRuntime.<span class="function">cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AndroidRuntime::start</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* className, <span class="type">const</span> Vector&lt;String8&gt;&amp; options, <span class="type">bool</span> zygote)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">&quot;start-system-server&quot;</span>)</span></span>;</span><br><span class="line">    <span class="comment">// Whether this is the primary zygote, meaning the zygote which will fork system server.</span></span><br><span class="line">    <span class="type">bool</span> primary_zygote = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; options.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        <span class="comment">// 传入的参数有start-system-server, primary_zygote设置为true</span></span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">            primary_zygote = <span class="literal">true</span>;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="type">const</span> <span class="type">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           <span class="built_in">LOG_EVENT_LONG</span>(LOG_BOOT_PROGRESS_START,  <span class="built_in">ns2ms</span>(<span class="built_in">systemTime</span>(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 设置环境变量，只列举ANDROID_ROOT，其他的省略</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* rootDir = <span class="built_in">getenv</span>(<span class="string">&quot;ANDROID_ROOT&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">&quot;/system&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">hasDir</span>(<span class="string">&quot;/system&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">LOG_FATAL</span>(<span class="string">&quot;No root directory specified, and /system does not exist.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">setenv</span>(<span class="string">&quot;ANDROID_ROOT&quot;</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.<span class="built_in">Init</span>(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">// 启动Java虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">startVm</span>(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">onVmCreated</span>(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为Java虚拟机注册JNI方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">startReg</span>(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;Unable to register all android natives\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment">     * Create an array to hold them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    <span class="built_in">assert</span>(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    strArray = env-&gt;<span class="built_in">NewObjectArray</span>(options.<span class="built_in">size</span>() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">assert</span>(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 从app_main的main函数得知className为com.android.internal.os.ZygoteInit</span></span><br><span class="line">    classNameStr = env-&gt;<span class="built_in">NewStringUTF</span>(className);</span><br><span class="line">    <span class="built_in">assert</span>(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;<span class="built_in">SetObjectArrayElement</span>(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; options.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;<span class="built_in">NewStringUTF</span>(options.<span class="built_in">itemAt</span>(i).<span class="built_in">string</span>());</span><br><span class="line">        <span class="built_in">assert</span>(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;<span class="built_in">SetObjectArrayElement</span>(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 将className的&quot;.&quot;替换为&quot;/&quot;</span></span><br><span class="line">    <span class="type">char</span>* slashClassName = <span class="built_in">toSlashClassName</span>(className != <span class="literal">NULL</span> ? className : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// 找到ZygoteInit</span></span><br><span class="line">    jclass startClass = env-&gt;<span class="built_in">FindClass</span>(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 找到ZygoteInit的main方法</span></span><br><span class="line">        jmethodID startMeth = env-&gt;<span class="built_in">GetStaticMethodID</span>(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">            <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 通过JNI调用ZygoteInit的main方法</span></span><br><span class="line">            env-&gt;<span class="built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>())</span><br><span class="line">                <span class="built_in">threadExitUncaughtException</span>(env);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>主要做了三件事：</p>
<ol>
<li>启动Java虚拟机</li>
<li>注册JNI函数</li>
<li>通过JNI调用ZygoteInit类的main方法</li>
</ol>
</li>
<li><p>最后通过JNI调用ZygoteInit的main方法，是因为ZygoteInit的main方法是Java语言编写的，当前的运行逻辑是在Native中，这就需要通过JNI来调用Java，这样Zygote就从Native层进入了Java框架层。此前是没有任何代码进入Java框架层的，是Zygote开创了Java框架层。</p>
</li>
</ul>
<h3 id="ZygoteInit"><a href="#ZygoteInit" class="headerlink" title="ZygoteInit"></a>ZygoteInit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> &#123;</span><br><span class="line">    <span class="type">ZygoteServer</span> <span class="variable">zygoteServer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标记Zygote开始</span></span><br><span class="line">    ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置Zygote自己的用户组pid</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Runnable caller;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读取系统是否已经启动完成</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isRuntimeRestarted</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>.equals(</span><br><span class="line">                SystemProperties.get(<span class="string">&quot;sys.boot_completed&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将行为写入trace log，标记目前处于ZygoteInit阶段</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bootTimeTag</span> <span class="operator">=</span> Process.is64Bit() ? <span class="string">&quot;Zygote64Timing&quot;</span> : <span class="string">&quot;Zygote32Timing&quot;</span>;</span><br><span class="line">        <span class="type">TimingsTraceLog</span> <span class="variable">bootTimingsTraceLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimingsTraceLog</span>(bootTimeTag,</span><br><span class="line">                Trace.TRACE_TAG_DALVIK);</span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">        RuntimeInit.preForkInit();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">startSystemServer</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// zygote进程就是一个socket，名称就叫zygote</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">zygoteSocketName</span> <span class="operator">=</span> <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">abiList</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">enableLazyPreload</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 解析参数设置对应标志位</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                startSystemServer = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                enableLazyPreload = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isPrimaryZygote</span> <span class="operator">=</span> zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line">        <span class="keyword">if</span> (!isRuntimeRestarted) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isPrimaryZygote) &#123;</span><br><span class="line">                FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                        BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__ZYGOTE_INIT_START,</span><br><span class="line">                        startTime);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (zygoteSocketName.equals(Zygote.SECONDARY_SOCKET_NAME)) &#123;</span><br><span class="line">                FrameworkStatsLog.write(FrameworkStatsLog.BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED,</span><br><span class="line">                        BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__SECONDARY_ZYGOTE_INIT_START,</span><br><span class="line">                        startTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (abiList == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">        <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">        <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygotePreload&quot;</span>);</span><br><span class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            <span class="comment">// 预加载资源</span></span><br><span class="line">            preload(bootTimingsTraceLog);</span><br><span class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygotePreload</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">        bootTimingsTraceLog.traceBegin(<span class="string">&quot;PostZygoteInitGC&quot;</span>);</span><br><span class="line">        gcAndFinalize();</span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// PostZygoteInitGC</span></span><br><span class="line"></span><br><span class="line">        bootTimingsTraceLog.traceEnd(); <span class="comment">// ZygoteInit</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个用于和SystemServer通信的socket</span></span><br><span class="line">        <span class="comment">// 当SystemServer fork出来后，socket进程将关闭</span></span><br><span class="line">        Zygote.initNativeState(isPrimaryZygote);</span><br><span class="line"></span><br><span class="line">        ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ZygoteServer</span></span><br><span class="line">        zygoteServer = <span class="keyword">new</span> <span class="title class_">ZygoteServer</span>(isPrimaryZygote);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            <span class="comment">// 调用native函数fork server_server进程</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">            <span class="comment">// child (system_server) process.</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote进入死循环</span></span><br><span class="line">        caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;System zygote died with fatal exception&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (zygoteServer != <span class="literal">null</span>) &#123;</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主要做了四件事：<ol>
<li>预加载资源；</li>
<li>创建一个server端的socket：ZygoteServer，接收应用进程fork请求；</li>
<li>fork出SystemServer进程；</li>
<li>进入死循环，poll阻塞接收fork请求。</li>
</ol>
</li>
<li>创建了2个socket，一个是systemServer socket，通过Zygote.initNativeState(isPrimaryZygote)来创建；一个是zygote socket，通过new ZygoteServer()来创建。</li>
</ul>
<h3 id="ZygoteServer"><a href="#ZygoteServer" class="headerlink" title="ZygoteServer"></a>ZygoteServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</span><br><span class="line"><span class="title function_">ZygoteServer</span><span class="params">(<span class="type">boolean</span> isPrimaryZygote)</span> &#123;</span><br><span class="line">    mUsapPoolEventFD = Zygote.getUsapPoolEventFD();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建socket，名称为zygote，路径：/dev/sockets/zygote</span></span><br><span class="line">    <span class="keyword">if</span> (isPrimaryZygote) &#123;</span><br><span class="line">        mZygoteSocket = 		Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/com/android/internal/os/Zygote.java</span><br><span class="line"><span class="keyword">static</span> LocalServerSocket <span class="title function_">createManagedSocketFromInitSocket</span><span class="params">(String socketName)</span> &#123;</span><br><span class="line">    <span class="type">int</span> fileDesc;</span><br><span class="line">    <span class="comment">// 拼接socket的名称，fullSocketName = &quot;ANDROID_SOCKET_zygote&quot;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fullSocketName</span> <span class="operator">=</span> ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 得到socket的环境变量的值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">env</span> <span class="operator">=</span> System.getenv(fullSocketName);</span><br><span class="line">        <span class="comment">// 将socket环境变量的值转换为文件描述符的参数</span></span><br><span class="line">        fileDesc = Integer.parseInt(env);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Socket unset or invalid: &quot;</span> + fullSocketName, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建文件描述符</span></span><br><span class="line">        <span class="type">FileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileDescriptor</span>();</span><br><span class="line">        fd.setInt$(fileDesc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocalServerSocket</span>(fd);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">            <span class="string">&quot;Error building socket from file descriptor: &quot;</span> + fileDesc, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/android/net/LocalServerSocket.java</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LocalServerSocket</span><span class="params">(FileDescriptor fd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 创建服务端socket并持续监听</span></span><br><span class="line">    impl = <span class="keyword">new</span> <span class="title class_">LocalSocketImpl</span>(fd);</span><br><span class="line">    impl.listen(LISTEN_BACKLOG);</span><br><span class="line">    localAddress = impl.getSockAddress();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Zygote运行于单独的进程中，是所有应用程序进程的孵化器。</li>
<li>Zygote进程启动做了以下几件事：<ol>
<li>创建AppRuntime并调用其start方法，启动Zygote进程；</li>
<li>创建Java虚拟机并为Java虚拟机注册JNI方法；</li>
<li>通过JNI调用ZygoteInit的main函数进入Zygote的Java框架层；</li>
<li>预加载资源；</li>
<li>创建服务端socket，fork出SystemServer进程；</li>
<li>进入死循环，poll接收fork请求。</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/Zygote%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="cltjvv1bh000n8q2uhfbj1k58" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-rc文件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/rc%E6%96%87%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.573Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="rc文件"><a href="#rc文件" class="headerlink" title="rc文件"></a><center>rc文件</center></h2><p>rc文件由安卓初始化语言编写，是配置文件，不是程序，不会被编译&#x2F;链接。可用于初始化系统服务、设置属性、创建系统资源等操作。rc文件在Init进程中完成扫描、解析、加载、执行等操作。</p>
<p>官方文档为<code>system/core/init/README.md</code>。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><ul>
<li><p>语法组成</p>
<ul>
<li><p>由五部分组成</p>
<ol>
<li>Action（行为）</li>
<li>Commands（命令）</li>
<li>Services（服务）</li>
<li>Options（选项）</li>
<li>Imports（导入）</li>
</ol>
</li>
<li><p>Comments（注释）：以#开头的行，表示注释（允许前导空格）。</p>
</li>
<li><p>Section（段落&#x2F;分组）</p>
<p>rc文件的基本单位，有三种类型：on、service、import</p>
</li>
<li><p>关键字和参数以空格分割，每个语句以行为单位。</p>
</li>
<li><p>C语言风格的反斜杠转义字符（“\”）可以用来为参数添加空格。</p>
</li>
<li><p>为了防止字符串中的空格把其切割成多个部分，需要对其使用双引号。</p>
</li>
<li><p>行尾的反斜杠用来表示下面一行是同一行。</p>
</li>
<li><p>Actions和Services暗示着一个新语句的开始，这两个关键字后面跟着的Commands或者Options都属于这个新语句。</p>
</li>
<li><p>Actions和Services有唯一的名字，如果出现和已有动作或者服务重名的，将会被当成错误忽略掉。</p>
</li>
</ul>
</li>
<li><p>on</p>
<ul>
<li><code>on early-init</code>：Init之前，加载完所有rc文件后即执行，init.rc在early-init执行的是<code>start ueventd</code>。</li>
<li><code>on init</code>：在&#x2F;init.conf（启动配置文件）被装载之后，加载propety各项属性文件之前执行，在Init变为property service之前都属于Init阶段。</li>
<li><code>late-init</code>：初始化之后执行。</li>
<li><code>on early-boot</code>：启动属性服务后即执行。</li>
<li><code>on boot</code>：boot的时候执行。</li>
<li><code>on property:xxxxx=x</code>：当某个属性设置为预期值时执行。</li>
<li><code>device-added-&lt;path&gt;</code>：指定设备被添加时触发。</li>
<li><code>device-removed-&lt;path&gt;</code> ：指定设备被移除时触发。</li>
<li><code>service-exited-&lt;name&gt; </code>：在特定服务（service）退出时触发。</li>
</ul>
</li>
<li><p>Trigger</p>
<p>触发器，本质上是字符串，用于匹配包含该字符串的事件（Event）。</p>
<ol>
<li><p>属性触发器</p>
<p>属性变为指定的属性值时触发。</p>
</li>
<li><p>事件触发器</p>
<p>通过QueueEventTrigger函数（C++），或trigger command触发。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">on xxx:</span><br><span class="line">	trigger sss</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Trigger可以由多个属性触发器 + 一个事件触发器组成。</p>
</li>
<li><p>Command</p>
<p>命令。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td>&#96;bootchart [start</td>
<td align="left">stop]&#96;</td>
</tr>
<tr>
<td><code>chmod &lt;octal-mode&gt; &lt;path&gt;</code></td>
<td align="left">设置文件权限</td>
</tr>
<tr>
<td><code>chown &lt;owner&gt; &lt;group&gt; &lt;path&gt;</code></td>
<td align="left">设置文件所有者和所有组</td>
</tr>
<tr>
<td><code>class_start &lt;serviceclass&gt;</code></td>
<td align="left">对于所有属于该class的service，若没有在运行中，则启动它们</td>
</tr>
<tr>
<td><code>class_stop &lt;serviceclass&gt;</code></td>
<td align="left">对于所有属于该class的service，若在运行中，则终止它们，且将状态改为不可用（disabled）</td>
</tr>
<tr>
<td><code>class_reset &lt;serviceclass&gt;</code></td>
<td align="left">终止，但不设置成disabled</td>
</tr>
<tr>
<td><code>class_restart [--only-enabled] &lt;serviceclass&gt;</code></td>
<td align="left">重新启动指定类的所有服务。如果指定了“–only-enabled”，则跳过禁用的服务。</td>
</tr>
<tr>
<td><code>copy &lt;src&gt; &lt;dst&gt;</code></td>
<td align="left">复制文件，可用于二进制、大量文件场景。复制后文件权限为0600，若目标文件已存在则终止操作</td>
</tr>
<tr>
<td><code>copy_per_line &lt;src&gt; &lt;dst&gt;</code></td>
<td align="left">逐行复制文件</td>
</tr>
<tr>
<td><code>domainname &lt;name&gt;</code></td>
<td align="left">设置域名</td>
</tr>
<tr>
<td><code>enable &lt;servicename&gt;</code></td>
<td align="left">将disabled的service设置为enable状态，如果service预期运行，则运行它</td>
</tr>
<tr>
<td><code>exec [ &lt;seclabel&gt; [ &lt;user&gt; [ &lt;group&gt;\ ] ] ] -- &lt;command&gt; [ &lt;argument&gt;\*] </code></td>
<td align="left">创建进程（fork）并且执行命令，可选参数为seclabel（安全上下文，security context），用户和组。Init进程会阻塞直至命令运行结束</td>
</tr>
<tr>
<td><code>exec_background [ &lt;seclabel&gt; [ &lt;user&gt; [ &lt;group&gt;\* ] ] ] -- &lt;command&gt; [ &lt;argument&gt;\* ]</code></td>
<td align="left">与“exec”命令的处理方式类似。不同之处在于，Init 不会停止执行命令，直到进程退出“exec_background”</td>
</tr>
<tr>
<td><code>exec_start &lt;service&gt;</code></td>
<td align="left">启动一个已声明的service，并阻塞Init直至该service运行结束。它与<code>exec</code>命令类似，只不过启动对象是已声明的service</td>
</tr>
<tr>
<td><code>export &lt;name&gt; &lt;value&gt;</code></td>
<td align="left">设置global域下的环境变量，所有进程（因为它们都是Init的子进程）都可与读取到该变量</td>
</tr>
<tr>
<td><code>hostname &lt;name&gt;</code></td>
<td align="left">设置host name</td>
</tr>
<tr>
<td><code>ifup &lt;interface&gt;</code></td>
<td align="left">启用网络</td>
</tr>
<tr>
<td><code>insmod [-f] &lt;path&gt; [&lt;options&gt;]</code></td>
<td align="left">安装module到路径path</td>
</tr>
<tr>
<td><code>interface_start &lt;name&gt;</code> <code>interface_restart &lt;name&gt;</code> <code>interface_stop &lt;name&gt;</code></td>
<td align="left">找到提供接口name的服务（如果存在），并分别对其运行“start”、“restart”或“stop”命令</td>
</tr>
<tr>
<td><code>load_exports &lt;path&gt;</code></td>
<td align="left">打开位于path的文件，并导出其中声明的全局环境变量</td>
</tr>
<tr>
<td><code>load_persist_props</code></td>
<td align="left">当&#x2F;data被解密时，加载persistent属性。在默认的init.rc中会执行该逻辑</td>
</tr>
<tr>
<td><code>loglevel &lt;level&gt;</code></td>
<td align="left">设置内核日志级别</td>
</tr>
<tr>
<td><code>mark_post_data</code></td>
<td align="left">&#x2F;data被挂载后标记point</td>
</tr>
<tr>
<td><code>mkdir &lt;path&gt; [mode] [owner] [group]</code></td>
<td align="left">创建目录，可选参数为读写权限、拥有者、组别，其默认值分别为755、root、root group</td>
</tr>
<tr>
<td><code>mount_all &lt;fstab&gt; [ &lt;path&gt; ]\* [--&lt;option&gt;]</code></td>
<td align="left">在fs_mgr-format的fstab上执行fs_mgr_mount_all，导入指定path下的.rc文件。可选参数为”early”和”late”</td>
</tr>
<tr>
<td><code>mount &lt;type&gt; &lt;device&gt; &lt;dir&gt; [ &lt;flag&gt;\* ] [&lt;options&gt;]</code></td>
<td align="left">将设备挂载到指定目录，flags包括”ro”, “rw”, “remount”, “noatime”等。options包括”barier&#x3D;1”, “noauto_da_alloc”等。</td>
</tr>
<tr>
<td><code>perform_apex_config</code></td>
<td align="left">挂载 APEX 后执行任务</td>
</tr>
<tr>
<td><code>restart [--only-if-running] &lt;service&gt;</code></td>
<td align="left">停止并重新启动正在运行的服务，如果服务当前正在重新启动，则不执行任何操作，否则，它只是启动服务。如果指定了“–only-if-running”，则仅当服务已在运行时重新启动服务。</td>
</tr>
<tr>
<td><code>restorecon &lt;path&gt; [ &lt;path&gt;\* ]</code></td>
<td align="left">恢复目录下的文件</td>
</tr>
<tr>
<td><code>restorecon_recursive &lt;path&gt; [ &lt;path&gt;\* ]</code></td>
<td align="left">递归恢复目录下的文件</td>
</tr>
<tr>
<td><code>rm &lt;path&gt;</code></td>
<td align="left">对于指定path调用unlink</td>
</tr>
<tr>
<td><code>rmdir &lt;path&gt;</code></td>
<td align="left">对于指定path调用rmdir</td>
</tr>
<tr>
<td>&#96;readahead &lt;file</td>
<td align="left">dir&gt; [–fully]&#96;</td>
</tr>
<tr>
<td><code>setprop &lt;name&gt; &lt;value&gt;</code></td>
<td align="left">设置属性值</td>
</tr>
<tr>
<td><code>setrlimit &lt;resource&gt; &lt;cur&gt; &lt;max&gt;</code></td>
<td align="left">设置资源的rlimit</td>
</tr>
<tr>
<td><code>start &lt;service&gt;</code></td>
<td align="left">开启service， 注意这个操作不是阻塞的，意味着start顺序不表示运行顺序，如果service之间有依赖顺序，须谨慎使用</td>
</tr>
<tr>
<td><code>stop &lt;service&gt;</code></td>
<td align="left">停止服务</td>
</tr>
<tr>
<td><code>swapon_all &lt;fstab&gt;</code></td>
<td align="left">在指定的fstab文件上调用fs_mgr_swapon_all</td>
</tr>
<tr>
<td><code>symlink &lt;target&gt; &lt;path&gt;</code></td>
<td align="left">创建符号链接</td>
</tr>
<tr>
<td><code>sysclktz &lt;mins_west_of_gmt&gt;</code></td>
<td align="left">设置系统时钟基础值（如果是GMT则为0）</td>
</tr>
<tr>
<td><code>trigger &lt;event&gt;</code></td>
<td align="left">触发一个事件，用于action之间互相触发</td>
</tr>
<tr>
<td><code>umount &lt;path&gt;</code></td>
<td align="left">卸载挂载在path上的文件系统</td>
</tr>
<tr>
<td><code>umount_all [ &lt;fstab&gt; ]</code></td>
<td align="left">对给定的 fstab 文件调用 fs_mgr_umount_all</td>
</tr>
<tr>
<td><code>verity_update_state</code></td>
<td align="left">更新dm-verity状态并设置 adb remount 使用的 partition.<em>mount-point</em>.verified属性</td>
</tr>
<tr>
<td><code>wait &lt;path&gt; [ &lt;timeout&gt; ]</code></td>
<td align="left">轮询指定path的文件是否存在，直到它出现或者超时，默认超时时间为5s</td>
</tr>
<tr>
<td><code>wait_for_prop &lt;name&gt; &lt;value&gt;</code></td>
<td align="left">等待直至属性被定义为指定值</td>
</tr>
<tr>
<td><code>write &lt;path&gt; &lt;content&gt;</code></td>
<td align="left">打开path的文件并写入一个string，若文件不存在则先创建它。若文件存在则续写</td>
</tr>
</tbody></table>
</li>
<li><p>Action</p>
<ol>
<li>Action是一系列Command的集合；</li>
<li>每个Action拥有一个Trigger，Trigger用来决定Action什么时候被执行；</li>
<li>当Trigger被触发，相应的Action会被添加到任务队列中（队尾插入），如果已在队列中则忽略；</li>
<li>Action中的每条命令，将会被顺序取出并执行。</li>
</ol>
<ul>
<li><p>语法格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span><br><span class="line">	&lt;command&gt;</span><br><span class="line">	&lt;command&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">on zygote-start &amp;&amp; property:ro.crypto.state=unsupport</span><br><span class="line">	start netd</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Option</p>
<p>Option是Services的修饰符（选项），通过Option告知Init如何对待Services。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>capabilities &lt;capability&gt; [&lt;capability&gt;\*]</code></td>
<td>当运行该service时，设置capability，capability是Linux系统中以”CAP_”为前缀的属性</td>
</tr>
<tr>
<td><code>class &lt;name&gt; [ &lt;name&gt;\* ]</code></td>
<td>声明service的类名，用来给service归类，所有在同一类名下的service可以被同时开启&#x2F;终止。默认类名是<code>default</code>。 例如可以将开机过程中的动画service归入<code>amination</code>类</td>
</tr>
<tr>
<td><code>console [&lt;console&gt;]</code></td>
<td>表明service需要在console环境下使用，可选参数声明了默认console以外的环境。通常默认的console是<code>/dev/console</code>。</td>
</tr>
<tr>
<td><code>critical [window=&lt;fatal crash window mins&gt;] [target=&lt;fatal reboot target&gt;]</code></td>
<td>这是对设备至关重要的一个服务。如果它在四分钟内退出超过四次，则设备将重启进入恢复模式。</td>
</tr>
<tr>
<td><code>disabled</code></td>
<td>表明service不会自动启动，必须显式地通过名字来启动</td>
</tr>
<tr>
<td><code>enter_namespace &lt;type&gt; &lt;path&gt;</code></td>
<td>进入位于path的type类型的命名空间</td>
</tr>
<tr>
<td><code>file &lt;path&gt; &lt;type&gt;</code></td>
<td>打开一个文件，并将fd传给启动的进程。type取值为”r”、”w”或者”rw”</td>
</tr>
<tr>
<td><code>gentle_kill</code></td>
<td>此服务停止时将发送 SIGTERM 而不是 SIGKILL。200 毫秒超时后，将发送 SIGKILL。</td>
</tr>
<tr>
<td><code>group &lt;groupname&gt; [&lt;groupbame&gt;\*]</code></td>
<td>在执行该service前，切换组为<code>&lt;groupname&gt;</code>，默认是root。除了（必需的）第一个组名之外，其他组名用于设置进程的补充组（通过 setgroups()）。</td>
</tr>
<tr>
<td><code>interface &lt;interface name&gt; &lt;instance name&gt;</code></td>
<td>将此服务与其提供的 AIDL 或 HIDL 服务列表相关联</td>
</tr>
<tr>
<td><code>ioprio &lt;class&gt; &lt;priority&gt;</code></td>
<td>设置IO优先级</td>
</tr>
<tr>
<td><code>keycodes &lt;keycode&gt; [ &lt;keycode&gt;\* ]</code></td>
<td>设置将触发此服务的键码。如果同时按下与设置的键码对应的所有键，则服务将启动。通常用于启动bugreport服务。</td>
</tr>
<tr>
<td><code>memcg.limit_in_bytes &lt;value&gt;</code></td>
<td>设置子进程的memory.limit_in_bytes ，不小于0</td>
</tr>
<tr>
<td><code>memcg.limit_property &lt;value&gt;</code></td>
<td>设置子进程的memory.limit_in_bytes为指定属性的值</td>
</tr>
<tr>
<td><code>memcg.soft_limit_in_bytes &lt;value&gt;</code></td>
<td>设置子进程的memory.soft_limit_in_bytes ，不小于0</td>
</tr>
<tr>
<td><code>memcg.swappiness &lt;value&gt;</code></td>
<td>设置子进程的memory.swappiness，不小于0</td>
</tr>
<tr>
<td>&#96;namespace &lt;pid</td>
<td>mnt&gt;&#96;</td>
</tr>
<tr>
<td><code>oneshot</code></td>
<td>当service退出时，不主动重启</td>
</tr>
<tr>
<td><code>onrestart</code></td>
<td>当service重启（restart） 时，执行该command</td>
</tr>
<tr>
<td><code>oom_score_adjust &lt;value&gt;</code></td>
<td>设置子进程的&#x2F;proc&#x2F;self&#x2F;oom_score_adj ，取值范围-1000~1000</td>
</tr>
<tr>
<td><code>override</code></td>
<td>此service旨在覆盖具有相同名称的服务的先前定义</td>
</tr>
<tr>
<td><code>priority &lt;priority&gt;</code></td>
<td>设置service进程的优先级，范围-20~19，默认优先级是0</td>
</tr>
<tr>
<td><code>reboot_on_failure &lt;target&gt;</code></td>
<td>如果无法启动此进程，或者进程终止时退出码不是 CLD_EXITED 或状态不是“0”，使用 target中指定的目标重启系统</td>
</tr>
<tr>
<td><code>restart_period &lt;seconds&gt;</code></td>
<td>如果非一次性服务退出，它将在其开始时间加上此时间段重新启动</td>
</tr>
<tr>
<td><code>rlimit &lt;resource&gt; &lt;cur&gt; &lt;max&gt;</code></td>
<td>将给定的 rlimit 应用于服务</td>
</tr>
<tr>
<td><code>seclabel &lt;seclabel&gt;</code></td>
<td>在运行该service之前，修改<code>seclabel</code>属性，通常从rootfs启动的service会使用该选项，如ueventd, adbd</td>
</tr>
<tr>
<td><code>setenv &lt;name&gt; &lt;value&gt;</code></td>
<td>表明在service的进程中设置一个环境属性</td>
</tr>
<tr>
<td><code>shutdown &lt;shutdown_behavior&gt;</code></td>
<td>设置该service进程的关机行为。若未声明，当关机时该service被SIGTERM和SIGKILL信号终止。被声明为<code>critical</code>的service不会在关机期间被终止，直至完全关机。被声明为<code>shutdown critical</code>的service会在关机期间启动（如果它没有在运行）</td>
</tr>
<tr>
<td><code>sigstop</code></td>
<td>在调用 exec 之前立即将 SIGSTOP 发送到服务，用于调试</td>
</tr>
<tr>
<td><code>socket &lt;name&gt; &lt;type&gt; &lt;perm&gt; [&lt;user&gt;[&lt;group&gt;[&lt;seclabel&gt;]]]</code></td>
<td>启动一个名为<code>/dev/socket/name</code>的socket，并且将它的fd传给当前进程，type必须是”dgram”、”stream”、或者”seqpacket”，seclabel是SELinux的设置</td>
</tr>
<tr>
<td><code>stdio_to_kmsg</code></td>
<td>将 stdout 和 stderr 重定向到 devkmsg_debug</td>
</tr>
<tr>
<td><code>task_profiles &lt;profile&gt; [ &lt;profile&gt;\* ]</code></td>
<td>设置任务配置文件</td>
</tr>
<tr>
<td><code>timeout_period &lt;seconds&gt;</code></td>
<td>提供超时，超过该时间点后，服务将被终止</td>
</tr>
<tr>
<td><code>updatable</code></td>
<td>标记该服务可以在启动序列中稍后被 APEX 覆盖（通过“覆盖”选项）</td>
</tr>
<tr>
<td><code>user &lt;username&gt;</code></td>
<td>在执行该service前，切换用户为<code>&lt;username&gt;</code>，默认是root</td>
</tr>
<tr>
<td><code>writepid &lt;file&gt; [ &lt;file&gt;\* ]</code></td>
<td>将创建子进程时，将其pid写入指定的文件</td>
</tr>
</tbody></table>
</li>
<li><p>Services</p>
<p>Services指一些Programs（程序），这些程序由Init启动&#x2F;重启。</p>
<ul>
<li><p>语法格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service &lt;name&gt; &lt;pathname&gt; [&lt;argument&gt;]*</span><br><span class="line">	&lt;option&gt;</span><br><span class="line">	&lt;option&gt;</span><br><span class="line">	&lt;option&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service gocsdk /system/bin/gocsdk</span><br><span class="line">    class main</span><br><span class="line">    disabled</span><br><span class="line">    oneshot</span><br></pre></td></tr></table></figure>

<p>gocsdk是服务的名字，这个可执行文件的位置在&#x2F;system&#x2F;bin&#x2F;gocsdk。disabled、oneshot是options，用来描述service的特点。</p>
</li>
</ul>
</li>
<li><p>Import</p>
<p>引入其他rc文件。</p>
<ul>
<li><p>语法格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &lt;path&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果path传入的是一个目录，则解析该目录下全部配置文件，非递归，嵌套目录不会被解析。</p>
</li>
<li><p>Init进程只在三个时间点执行import指令：</p>
<ol>
<li>在启动过程中解析系统根目录的&#x2F;init.rc，或者是ro.boot.init_rc属性指明的rc文件；</li>
<li>在解析完&#x2F;init.rc，启动第一阶段时解析&#x2F;{system,vendor,odm}&#x2F;etc&#x2F;init&#x2F;文件；</li>
<li>在mount_all指令中解析&#x2F;{system,vendor,odm}&#x2F;etc&#x2F;init&#x2F;。</li>
</ol>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/rc%E6%96%87%E4%BB%B6/" data-id="cltjvv1bi000p8q2u9vesfbhq" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Window的添加过程（WMS处理部分）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/09/Window%E7%9A%84%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B%EF%BC%88WMS%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2024-03-09T07:30:58.572Z" itemprop="datePublished">2024-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Window的添加过程（WMS处理部分）"><a href="#Window的添加过程（WMS处理部分）" class="headerlink" title="Window的添加过程（WMS处理部分）"></a><center>Window的添加过程（WMS处理部分）</center></h2><blockquote>
<p>基于Android U</p>
</blockquote>
<p>我们知道Window的操作分为两大部分，一部分是WindowManager处理部分，另一部分是WMS处理部分。对于WMS处理部分，无论是系统窗口还是Activity，它们的Window的添加过程都会调用WMS的addWindow()方法。</p>
<h4 id="addWindow-方法part1"><a href="#addWindow-方法part1" class="headerlink" title="addWindow()方法part1"></a>addWindow()方法part1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addWindow</span><span class="params">(Session session, IWindow client, LayoutParams attrs, <span class="type">int</span> viewVisibility,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> displayId, <span class="type">int</span> requestUserId, <span class="meta">@InsetsType</span> <span class="type">int</span> requestedVisibleTypes,</span></span><br><span class="line"><span class="params">        InputChannel outInputChannel, InsetsState outInsetsState,</span></span><br><span class="line"><span class="params">        InsetsSourceControl.Array outActiveControls, Rect outAttachedFrame,</span></span><br><span class="line"><span class="params">        <span class="type">float</span>[] outSizeCompatScale)</span> &#123;</span><br><span class="line">    outActiveControls.set(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">int</span>[] appOp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isRoundedCornerOverlay</span> <span class="operator">=</span> (attrs.privateFlags</span><br><span class="line">            &amp; PRIVATE_FLAG_IS_ROUNDED_CORNERS_OVERLAY) != <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mPolicy.checkAddPermission(attrs.type, isRoundedCornerOverlay, attrs.packageName,</span><br><span class="line">            appOp);  <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (res != ADD_OKAY) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mGlobalLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDisplayReady) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Display has not been initialialized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">DisplayContent</span> <span class="variable">displayContent</span> <span class="operator">=</span> getDisplayContentOrCreate(displayId, attrs.token);  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (displayContent == <span class="literal">null</span>) &#123;</span><br><span class="line">            ProtoLog.w(WM_ERROR, <span class="string">&quot;Attempted to add window to a display that does &quot;</span></span><br><span class="line">                    + <span class="string">&quot;not exist: %d. Aborting.&quot;</span>, displayId);</span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_INVALID_DISPLAY;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (type &gt;= FIRST_SUB_WINDOW &amp;&amp; type &lt;= LAST_SUB_WINDOW) &#123;  <span class="comment">// 3</span></span><br><span class="line">            parentWindow = windowForClientLocked(<span class="literal">null</span>, attrs.token, <span class="literal">false</span>);  <span class="comment">// 4</span></span><br><span class="line">            <span class="keyword">if</span> (parentWindow == <span class="literal">null</span>) &#123;</span><br><span class="line">                ProtoLog.w(WM_ERROR, <span class="string">&quot;Attempted to add window with token that is not a window: &quot;</span></span><br><span class="line">                        + <span class="string">&quot;%s.  Aborting.&quot;</span>, attrs.token);</span><br><span class="line">                <span class="keyword">return</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (parentWindow.mAttrs.type &gt;= FIRST_SUB_WINDOW</span><br><span class="line">                    &amp;&amp; parentWindow.mAttrs.type &lt;= LAST_SUB_WINDOW) &#123;</span><br><span class="line">                ProtoLog.w(WM_ERROR, <span class="string">&quot;Attempted to add window with token that is a sub-window: &quot;</span></span><br><span class="line">                        + <span class="string">&quot;%s.  Aborting.&quot;</span>, attrs.token);</span><br><span class="line">                <span class="keyword">return</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WMS的addWindow()返回的是addWindow的各种状态，比如添加Window成功，无效的display等，这些状态被定义在WindowManagerGlobal中。</p>
<p>在注释1处根据Window的属性，调用WMP的checkAddPermission()方法来检查权限，具体在PhoneWindowManager的checkAddPermission()方法中实现，如果没有权限则不会执行后续的代码逻辑。</p>
<p>在注释2处通过displayId来获得窗口要添加到哪个DisplayContent上，如果没有找到DisplayContent，则返回WindowManagerGlobal.ADD_INVALID_DISPLAY这一状态，其中DisplayContent用来描述一块屏幕。</p>
<p>在注释3处，type代表一个窗口的类型，它的数值介于FIRST_SUB_WINDOW和LAST_SUB_WINDOW之间（1000～1999），这个数值定义在WindowManager中，说明这个窗口是一个子窗口。</p>
<p>在注释4处，attrs.token是IBinder类型的对象，windowForClientLocked()方法内部会根据attrs.token作为key值从mWindowMap中得到该子窗口的父窗口。接着对父窗口进行判断，如果父窗口为null或者type的取值范围不正确则会返回错误的状态。</p>
<h4 id="addWindow-方法part2"><a href="#addWindow-方法part2" class="headerlink" title="addWindow()方法part2"></a>addWindow()方法part2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addWindow</span><span class="params">(Session session, IWindow client, LayoutParams attrs, <span class="type">int</span> viewVisibility,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> displayId, <span class="type">int</span> requestUserId, <span class="meta">@InsetsType</span> <span class="type">int</span> requestedVisibleTypes,</span></span><br><span class="line"><span class="params">        InputChannel outInputChannel, InsetsState outInsetsState,</span></span><br><span class="line"><span class="params">        InsetsSourceControl.Array outActiveControls, Rect outAttachedFrame,</span></span><br><span class="line"><span class="params">        <span class="type">float</span>[] outSizeCompatScale)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mGlobalLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">hasParent</span> <span class="operator">=</span> parentWindow != <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Use existing parent window token for child windows since they go in the same token</span></span><br><span class="line">        <span class="comment">// as there parent window so we can apply the same policy on them.</span></span><br><span class="line">        <span class="type">WindowToken</span> <span class="variable">token</span> <span class="operator">=</span> displayContent.getWindowToken(</span><br><span class="line">                hasParent ? parentWindow.mAttrs.token : attrs.token);  <span class="comment">// 1</span></span><br><span class="line">        <span class="comment">// If this is a child window, we want to apply the same type checking rules as the</span></span><br><span class="line">        <span class="comment">// parent window type.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">rootType</span> <span class="operator">=</span> hasParent ? parentWindow.mAttrs.type : type;  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">addToastWindowRequiresToken</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">windowContextToken</span> <span class="operator">=</span> attrs.mWindowContextToken;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;  <span class="comment">// 3</span></span><br><span class="line">             <span class="keyword">if</span> (!unprivilegedAppCanCreateTokenWith(parentWindow, callingUid, type,</span><br><span class="line">                    rootType, attrs.token, attrs.packageName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> WindowManagerGlobal.ADD_BAD_APP_TOKEN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (hasParent) &#123;</span><br><span class="line">                <span class="comment">// Use existing parent window token for child windows.</span></span><br><span class="line">                token = parentWindow.mToken;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mWindowContextListenerController.hasListener(windowContextToken)) &#123;</span><br><span class="line">                <span class="comment">// Respect the window context token if the user provided it.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> attrs.token != <span class="literal">null</span> ? attrs.token : windowContextToken;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> mWindowContextListenerController</span><br><span class="line">                        .getOptions(windowContextToken);</span><br><span class="line">                token = <span class="keyword">new</span> <span class="title class_">WindowToken</span>.Builder(<span class="built_in">this</span>, binder, type)</span><br><span class="line">                        .setDisplayContent(displayContent)</span><br><span class="line">                        .setOwnerCanManageAppTokens(session.mCanAddInternalSystemWindow)</span><br><span class="line">                        .setRoundedCornerOverlay(isRoundedCornerOverlay)</span><br><span class="line">                        .setFromClientToken(<span class="literal">true</span>)</span><br><span class="line">                        .setOptions(options)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> attrs.token != <span class="literal">null</span> ? attrs.token : client.asBinder();</span><br><span class="line">                token = <span class="keyword">new</span> <span class="title class_">WindowToken</span>.Builder(<span class="built_in">this</span>, binder, type)</span><br><span class="line">                        .setDisplayContent(displayContent)</span><br><span class="line">                        .setOwnerCanManageAppTokens(session.mCanAddInternalSystemWindow)</span><br><span class="line">                        .setRoundedCornerOverlay(isRoundedCornerOverlay)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    	... <span class="comment">// 省略一些else if</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处通过displayContent的getWindowToken()方法得到WindowToken。</p>
<p>注释2处，如果有父窗口就将父窗口的type值赋值给rootType，如果没有，将当前窗口的type值赋值给rootType。</p>
<p>注释3处，如果WindowToken为null，则创建WindowToken。</p>
<h4 id="addWindow-方法part3"><a href="#addWindow-方法part3" class="headerlink" title="addWindow()方法part3"></a>addWindow()方法part3</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addWindow</span><span class="params">(Session session, IWindow client, LayoutParams attrs, <span class="type">int</span> viewVisibility,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> displayId, <span class="type">int</span> requestUserId, <span class="meta">@InsetsType</span> <span class="type">int</span> requestedVisibleTypes,</span></span><br><span class="line"><span class="params">        InputChannel outInputChannel, InsetsState outInsetsState,</span></span><br><span class="line"><span class="params">        InsetsSourceControl.Array outActiveControls, Rect outAttachedFrame,</span></span><br><span class="line"><span class="params">        <span class="type">float</span>[] outSizeCompatScale)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mGlobalLock) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">WindowState</span> <span class="variable">win</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WindowState</span>(<span class="built_in">this</span>, session, client, token, parentWindow,</span><br><span class="line">                appOp[<span class="number">0</span>], attrs, viewVisibility, session.mUid, userId,</span><br><span class="line">                session.mCanAddInternalSystemWindow);  <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (win.mDeathRecipient == <span class="literal">null</span>) &#123;  <span class="comment">// 2</span></span><br><span class="line">            <span class="comment">// Client has apparently died, so there is no reason to</span></span><br><span class="line">            <span class="comment">// continue.</span></span><br><span class="line">            ProtoLog.w(WM_ERROR, <span class="string">&quot;Adding window client %s&quot;</span></span><br><span class="line">                    + <span class="string">&quot; that is dead, aborting.&quot;</span>, client.asBinder());</span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (win.getDisplayContent() == <span class="literal">null</span>) &#123;  <span class="comment">// 3</span></span><br><span class="line">            ProtoLog.w(WM_ERROR, <span class="string">&quot;Adding window to Display that has been removed.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> WindowManagerGlobal.ADD_INVALID_DISPLAY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">DisplayPolicy</span> <span class="variable">displayPolicy</span> <span class="operator">=</span> displayContent.getDisplayPolicy();</span><br><span class="line">        displayPolicy.adjustWindowParamsLw(win, win.mAttrs);  <span class="comment">// 4</span></span><br><span class="line">        attrs.flags = sanitizeFlagSlippery(attrs.flags, win.getName(), callingUid, callingPid);</span><br><span class="line">        attrs.inputFeatures = sanitizeSpyWindow(attrs.inputFeatures, win.getName(), callingUid,</span><br><span class="line">                callingPid);</span><br><span class="line">        win.setRequestedVisibleTypes(requestedVisibleTypes);</span><br><span class="line"></span><br><span class="line">        res = displayPolicy.validateAddingWindowLw(attrs, callingPid, callingUid);  <span class="comment">// 5</span></span><br><span class="line">        ...</span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);  <span class="comment">// 6</span></span><br><span class="line">        win.initAppOpsState();</span><br><span class="line">        ...</span><br><span class="line">        win.mToken.addWindow(win);  <span class="comment">// 7</span></span><br><span class="line">        displayPolicy.addWindowLw(win, attrs);</span><br><span class="line">        displayPolicy.setDropInputModePolicy(win, win.mAttrs);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1处创建了WindowState，它存有窗口的所有的状态信息，在WMS中它代表一个窗口。在创建WindowState传入的参数中，this指的是WMS，client指的是IWindow，IWindow会将WMS中窗口管理的操作回调给ViewRootImpl，token指的是WindowToken。</p>
<p>注释2、3处分别判断请求添加窗口的客户端是否已经死亡、窗口的DisplayContent是否为null，如果是则不会再执行下面的代码逻辑。</p>
<p>注释4处调用了DisplayPolicy的adjustWindowParamsLw()方法，此方法会根据窗口的type对窗口的LayoutParams的一些成员变量进行修改。</p>
<p>注释5处检查Window是否可以被添加到系统中。</p>
<p>注释6处将WindowState添加到mWindowMap中。</p>
<p>注释7处将WindowState添加到该WindowState对应的WindowToken中（实际是保存在WindowToken的父类WindowContainer中），这样WindowToken就包含了同一个组件的WindowState。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/09/Window%E7%9A%84%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B%EF%BC%88WMS%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86%EF%BC%89/" data-id="cltjvv1bg000k8q2uesd8gsdo" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/03/09/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/03/09/%E5%B9%BF%E6%92%AD%E7%9A%84%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E8%BF%87%E7%A8%8B/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/03/09/%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/03/09/%E8%BD%AF%E9%87%8D%E5%90%AF%E5%8A%9F%E8%83%BD%E8%B0%83%E7%A0%94/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/03/09/%E4%B8%8A%E4%B8%8B%E6%96%87Context/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>